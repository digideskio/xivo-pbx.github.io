<!DOCTYPE html>
<html lang="en">
<head>
  <link href='//fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,700,400italic' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" type="text/css" href="http://blog.xivo.io/theme/css/style.min.css">
  <link rel="stylesheet" type="text/css" href="http://blog.xivo.io/theme/css/pygments.min.css">
  <link rel="stylesheet" type="text/css" href="http://blog.xivo.io/theme/css/font-awesome.min.css">
  <link href="http://blog.xivo.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="XiVO Blog Atom">
  <link rel="shortcut icon" href="/public/favicon.ico" type="image/x-icon">
  <link rel="icon" href="/public/favicon.ico" type="image/x-icon">

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="" />
  <meta name="author" content="XiVO developers" />
  <meta name="description" content="" />
<meta property="og:site_name" content="XiVO Blog"/>
<meta property="og:type" content="blog"/>
<meta property="og:title" content="XiVO Blog"/>
<meta property="og:description" content=""/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content="http://blog.xivo.io"/>
<meta property="og:image" content="public/xivo-logo.png">
  <title>XiVO Blog</title>
</head>
<body>
  <aside>
    <div>
      <a href="http://blog.xivo.io">
        <img src="public/xivo-logo.png" alt="" title="">
      </a>
      <h1><a href="http://blog.xivo.io"></a></h1>
      <p></p>
      <nav>
        <ul class="list">
          <li><a href="http://xivo.io" target="_blank">XiVO.io</a></li>
          <li><a href="http://documentation.xivo.io" target="_blank">Documentation</a></li>
        </ul>
      </nav>
      <ul class="social">
        <li><a class="sc-twitter" href="http://twitter.com/xivodevteam" target="_blank"><i class="fa fa-twitter"></i></a></li>
        <li><a class="sc-github" href="http://github.com/xivo-pbx" target="_blank"><i class="fa fa-github"></i></a></li>
        <li><a class="sc-facebook" href="https://www.facebook.com/XiVO-86529730831" target="_blank"><i class="fa fa-facebook"></i></a></li>
      </ul>
    </div>
  </aside>
  <main>
    <nav>
      <a href="http://blog.xivo.io">Home</a>
      <a href="/categories.html">Categories</a>
      <a href="/archives.html">Archives</a>
      <a href="http://blog.xivo.io/feeds/all.atom.xml">Atom</a>
    </nav>

<article>
  <header>
    <h2><a href="http://blog.xivo.io/xivo-packages-versions.html#xivo-packages-versions">XiVO packages versions</a></h2>
    <p>
      Posted on Mon 02 May 2011 in <a href="http://blog.xivo.io/category/xivo-ipbx.html">XiVO IPBX</a>
      &#8226; Tagged with
      <a href="http://blog.xivo.io/tag/packages.html">packages</a>    </p>
  </header>
  <div>
      <h4>package names and multiple distributions</h4>
<p>As it is, packaging-farm will create packages with names that are not
dependent on the distribution. It creates a problem that is immediately
visible when trying to build a repository that includes all the
packages: the pool can only accomodate for a single package with a given
name.When building packages for multiple distributions, packaging-farm
should rename the packages built so that they carry the distribution
name. The names must compare in the same order as the distribution
chronology. For instance, <em>foo-1.2-1</em> would be renamed into
<em>foo-1.2-1\~3wheezy</em>. Such a behavior is intrusive and may not be
appropriate if building for a single distribution. The proposed names
are as follow, for each of the supported distributions, following the
<a href="http://backports.debian.org/Contribute/#index5h3">Debian GNU/Linux
backport</a> naming
scheme, with the distribution name added for clarity:</p>
<div class="highlight"><pre><span></span>* <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;https://wiki.ubuntu.com/Releases&quot;</span><span class="nt">&gt;</span>Ubuntu<span class="nt">&lt;/a&gt;</span>
** natty = ~bpo1104natty+1
** maverick = ~bpo1010maverick+1
** lucid = ~bpo1004lucid+1
** etc.
* <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://wiki.debian.org/DebianReleases&quot;</span><span class="nt">&gt;</span>Debian GNU/Linux<span class="nt">&lt;/a&gt;</span>
** wheezy = ~bpo70wheezy+1
** squeeze = ~bpo60squeeze+1
** lenny = ~bpo50lenny+1
** etch = ~bpo40etch+1
** etc.
</pre></div>


<p>For the record, here is the chat log that led to the proposal above.</p>
<div class="highlight"><pre><span></span><span class="p">(</span><span class="mi">10</span><span class="s s-Atom">:</span><span class="mi">29</span><span class="s s-Atom">:</span><span class="mi">46</span> <span class="nv">AM</span><span class="p">)</span> <span class="nn">loicd</span><span class="p">:</span> <span class="nv">Hi</span><span class="p">,</span> <span class="nv">I</span><span class="s s-Atom">&#39;m facing a problem organizing repositories made with reprepro. A package (the name is xivo) is fit to build for Debian wheezy, unstable &amp; Ubunty maverick and naty, for i386 &amp; amd64, without requiring any change. Because reprepro uses a pool to store the packages, these four packages (for wheezy, unstable, maverick &amp; naty) cannot coexist with the exact same name. I could either a) change the package name by adding the target distribution although these packages are strictly identical, b) make a separate repository for each distribution (which still is useful to aggregate the various architectures). Do you have any advice ?</span>
<span class="s s-Atom">(10:30:43 AM) twb: FWIW I just use apt-ftparchive</span>
<span class="s s-Atom">(10:31:44 AM) twb: http://paste.debian.net/115729/</span>
<span class="s s-Atom">(10:31:49 AM) twb: Not very nice, but it does the job</span>
<span class="s s-Atom">(10:32:51 AM) loicd: twb: you mean that it is imune to this kind of trouble (the pool) ? (10:34:57 AM) twb: Basically each dir is an apt repo</span>
<span class="s s-Atom">(10:35:26 AM) twb: So instead of dists/ and pool/x/xivo, you&#39;d</span> <span class="s s-Atom">just</span> <span class="s s-Atom">have</span> <span class="s s-Atom">xivo</span><span class="o">/</span> <span class="s s-Atom">as</span> <span class="s s-Atom">a</span> <span class="s s-Atom">repo</span><span class="p">,</span> <span class="s s-Atom">and</span> <span class="s s-Atom">you</span> <span class="s s-Atom">can</span> <span class="s s-Atom">point</span> <span class="s s-Atom">whatever</span> <span class="s s-Atom">distros</span> <span class="s s-Atom">you</span> <span class="s s-Atom">want</span> <span class="s s-Atom">at</span> <span class="nf">it</span>
<span class="p">(</span><span class="mi">10</span><span class="s s-Atom">:</span><span class="mi">41</span><span class="s s-Atom">:</span><span class="mi">02</span> <span class="nv">AM</span><span class="p">)</span> <span class="nn">loicd</span><span class="p">:</span> <span class="nn">twb</span><span class="p">:</span> <span class="s s-Atom">it</span> <span class="s s-Atom">looks</span> <span class="s s-Atom">like</span> <span class="s s-Atom">what</span> <span class="nv">I</span><span class="s s-Atom">&#39;m after. One drawback of having the same package name for two distro is upgrade. The following use case is broken : a) install wheezy + xivo, b) upgrade to unstable =&gt; xivo does not get upgraded. Although the source packages are the same, the resulting .deb are different because the context is different. The ideal situation would be to be able to create .deb with a name that contains the distro in such a way that it upgrades.</span>
<span class="s s-Atom">(10:41:54 AM) ***OdyX does -1 upload to Debian, then -1~n0 to natty, -1~m0 to maverick -1~l0 to lucid.</span>
<span class="s s-Atom">(10:44:39 AM) loicd: OdyX: smart :-)</span>
<span class="s s-Atom">(10:45:24 AM) OdyX: loicd: more or less ~. It means you have to rebuild+upload each time (only source if you upload to PPAs)</span>
<span class="s s-Atom">(10:46:55 AM) loicd: twb: I actually have the same problem with squeeze + wheezy. </span>
<span class="s s-Atom">(10:47:09 AM) twb: loicd: squeeze is BPO&#39;s</span> <span class="s s-Atom">problem</span><span class="p">,</span> <span class="o">not</span> <span class="s s-Atom">yours</span> <span class="s s-Atom">:</span><span class="nv">P</span>
<span class="p">(</span><span class="mi">10</span><span class="s s-Atom">:</span><span class="mi">47</span><span class="s s-Atom">:</span><span class="mi">20</span> <span class="nv">AM</span><span class="p">)</span> <span class="nn">loicd</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="s s-Atom">~s0</span> <span class="o">=</span> <span class="s s-Atom">squeeze</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="s s-Atom">~</span><span class="nf">w0</span> 
<span class="p">(</span><span class="mi">10</span><span class="s s-Atom">:</span><span class="mi">47</span><span class="s s-Atom">:</span><span class="mi">24</span> <span class="nv">AM</span><span class="p">)</span> <span class="nn">loicd</span><span class="p">:</span> <span class="s s-Atom">that</span> <span class="s s-Atom">works</span> <span class="nf">too</span>
<span class="p">(</span><span class="mi">11</span><span class="s s-Atom">:</span><span class="mi">10</span><span class="s s-Atom">:</span><span class="mi">37</span> <span class="nv">AM</span><span class="p">)</span> <span class="nn">loicd</span><span class="p">:</span> <span class="nn">twb</span><span class="p">:</span> <span class="s s-Atom">actually</span><span class="p">,</span> <span class="s s-Atom">it</span> <span class="o">is</span><span class="p">.</span> <span class="nv">The</span> <span class="s s-Atom">vendor</span> <span class="s s-Atom">of</span> <span class="s s-Atom">the</span> <span class="s s-Atom">software</span> <span class="s s-Atom">needs</span> <span class="s s-Atom">to</span> <span class="s s-Atom">provide</span> <span class="s s-Atom">squeeze</span> <span class="s s-Atom">backports</span> <span class="s s-Atom">to</span> <span class="s s-Atom">its</span> <span class="s s-Atom">clients</span><span class="p">.</span> <span class="nv">This</span> <span class="s s-Atom">happens</span> <span class="s s-Atom">usually</span> <span class="s s-Atom">in</span> <span class="s s-Atom">a</span> <span class="s s-Atom">rush</span> <span class="s s-Atom">and</span> <span class="s s-Atom">before</span> <span class="s s-Atom">it</span> <span class="s s-Atom">becomes</span> <span class="s s-Atom">available</span> <span class="s s-Atom">to</span> <span class="s s-Atom">bpo</span><span class="p">.</span> <span class="nv">It</span> <span class="s s-Atom">actually</span> <span class="o">is</span> <span class="s s-Atom">a</span> <span class="s s-Atom">concern</span> <span class="s s-Atom">shared</span> <span class="s s-Atom">by</span> <span class="s s-Atom">most</span> <span class="s s-Atom">software</span> <span class="s s-Atom">vendors</span> <span class="s s-Atom">:</span> <span class="s s-Atom">the</span> <span class="s s-Atom">delays</span> <span class="s s-Atom">between</span> <span class="s s-Atom">meeting</span> <span class="s s-Atom">the</span> <span class="s s-Atom">client</span> <span class="s s-Atom">request</span> <span class="s s-Atom">and</span> <span class="s s-Atom">meeting</span> <span class="s s-Atom">the</span> <span class="s s-Atom">debian</span> <span class="s s-Atom">requirements</span> <span class="s s-Atom">do</span> <span class="o">not</span> <span class="s s-Atom">always</span> <span class="s s-Atom">match</span><span class="p">.</span>
<span class="p">(</span><span class="mi">11</span><span class="s s-Atom">:</span><span class="mi">41</span><span class="s s-Atom">:</span><span class="mi">55</span> <span class="nv">AM</span><span class="p">)</span> <span class="nn">loicd</span><span class="p">:</span> <span class="nv">I</span> <span class="s s-Atom">think</span> <span class="nv">I</span> <span class="s s-Atom">will</span> <span class="s s-Atom">go</span> <span class="s s-Atom">for</span> <span class="s s-Atom">names</span> <span class="s s-Atom">that</span> <span class="s s-Atom">use</span> <span class="s s-Atom">the</span> <span class="s s-Atom">version</span> <span class="s s-Atom">number</span> <span class="s s-Atom">to</span> <span class="s s-Atom">ensure</span> <span class="s s-Atom">it</span> <span class="s s-Atom">compares</span> <span class="s s-Atom">as</span> <span class="s s-Atom">expected</span> <span class="s s-Atom">foo</span><span class="o">-</span><span class="mf">1.2</span><span class="o">-</span><span class="mi">1</span> <span class="s s-Atom">=&gt;</span> <span class="s s-Atom">foo</span><span class="o">-</span><span class="mf">1.2</span><span class="o">-</span><span class="mi">1</span><span class="s s-Atom">~</span><span class="mf">7.0</span><span class="nf">wheezy</span> <span class="p">(</span> <span class="s s-Atom">wheezy</span> <span class="o">=</span> <span class="s s-Atom">~</span><span class="mf">7.0</span><span class="s s-Atom">wheezy</span><span class="p">,</span> <span class="s s-Atom">squeeze</span> <span class="o">=</span> <span class="s s-Atom">~</span><span class="mf">6.0</span><span class="s s-Atom">squeeze</span><span class="p">,</span> <span class="s s-Atom">lenny</span> <span class="o">=</span> <span class="s s-Atom">~</span><span class="mf">5.0</span><span class="s s-Atom">lenny</span> <span class="s s-Atom">etc</span><span class="p">.).</span> <span class="nv">What</span> <span class="s s-Atom">do</span> <span class="s s-Atom">you</span> <span class="s s-Atom">think</span> <span class="s s-Atom">?</span> 
<span class="p">(</span><span class="mi">11</span><span class="s s-Atom">:</span><span class="mi">42</span><span class="s s-Atom">:</span><span class="mi">31</span> <span class="nv">AM</span><span class="p">)</span> <span class="nn">daemonkeeper</span><span class="p">:</span> <span class="s s-Atom">why</span> <span class="s s-Atom">use</span> <span class="s s-Atom">the</span> <span class="s s-Atom">codename</span> <span class="s s-Atom">at</span> <span class="s s-Atom">all</span> <span class="s s-Atom">then?</span>
<span class="p">(</span><span class="mi">11</span><span class="s s-Atom">:</span><span class="mi">43</span><span class="s s-Atom">:</span><span class="mi">45</span> <span class="nv">AM</span><span class="p">)</span> <span class="nn">twb</span><span class="p">:</span> <span class="nv">If</span> <span class="s s-Atom">the</span> <span class="s s-Atom">backport</span> <span class="s s-Atom">doesn&#39;t involve a source package change, I don&#39;t</span> <span class="s s-Atom">really</span> <span class="s s-Atom">see</span> <span class="s s-Atom">why</span> <span class="s s-Atom">it&#39;s necessary to fuck about at all</span>
<span class="s s-Atom">(11:45:14 AM) pabs: loicd: don&#39;t</span> <span class="s s-Atom">you</span> <span class="s s-Atom">want</span> <span class="s s-Atom">dch</span> <span class="s s-Atom">--bpo?</span>
<span class="p">(</span><span class="mi">11</span><span class="s s-Atom">:</span><span class="mi">45</span><span class="s s-Atom">:</span><span class="mi">53</span> <span class="nv">AM</span><span class="p">)</span> <span class="nn">loicd</span><span class="p">:</span> <span class="nn">daemonkeeper</span><span class="p">:</span> <span class="s s-Atom">for</span> <span class="s s-Atom">readability</span><span class="p">.</span> <span class="nv">I</span> <span class="s s-Atom">agree</span> <span class="s s-Atom">it&#39;s redundant.</span>
<span class="s s-Atom">(11:46:06 AM) loicd: but it will help the customer support, I suppose</span>
<span class="s s-Atom">(11:48:37 AM) loicd: twb: because the dependencies change and the binary packages being built are actually different. I agree that it would be completly pointless if they were python sources for instance. But in the case of compiled binaries, if the distribution is being upgraded the binary package must also be upgraded. If it had the same name it would not upgrade and be broken.</span>
<span class="s s-Atom">(11:49:05 AM) twb: loicd: ah right</span>
<span class="s s-Atom">(12:07:54 PM) loicd: pabs: thanks for pointing out bpo. I will follow the bpo naming scheme so that it&#39;s</span> <span class="s s-Atom">compatible</span> <span class="s s-Atom">with</span> <span class="s s-Atom">bpo</span><span class="p">.</span> <span class="nv">And</span> <span class="s s-Atom">it</span><span class="err">&#39;</span><span class="s s-Atom">s</span> <span class="s s-Atom">a</span> <span class="s s-Atom">lot</span> <span class="s s-Atom">better</span> <span class="s s-Atom">to</span> <span class="s s-Atom">adopt</span> <span class="s s-Atom">an</span> <span class="s s-Atom">existing</span> <span class="s s-Atom">convention</span> <span class="p">;</span><span class="s s-Atom">-</span><span class="p">)</span> <span class="nn">http</span><span class="p">:</span><span class="o">//</span><span class="s s-Atom">backports</span><span class="p">.</span><span class="s s-Atom">debian</span><span class="p">.</span><span class="s s-Atom">org</span><span class="o">/</span><span class="nv">Contribute</span><span class="s s-Atom">/#</span><span class="nf">index5h3</span> <span class="o">:-</span><span class="p">)</span>
</pre></div>


<h4>natty support and documentation</h4>
<p>Support for <a href="https://wiki.ubuntu.com/NattyNarwhal">natty</a> was added by
creating a virtual machine using <a href="http://mirrors.ircam.fr/pub/ubuntu/releases//natty/ubuntu-11.04-server-amd64.iso">the server
distribution</a>
and creating i386 and x86_64 chroots with:</p>
<div class="highlight"><pre><span></span>pbuilder --create --architecture i386 --basetgz /var/cache/pbuilder/natty-i386.tgz
pbuilder --create --architecture amd64 --basetgz /var/cache/pbuilder/natty-amd64.tgz
</pre></div>


<p>and untaring them into the packaging-farm <a href="http://packaging-farm.dachary.org/chroot/">rsync
repository</a> for
<a href="http://packaging-farm.dachary.org/chroot/debian/i386/natty/">i386</a> and
<a href="http://packaging-farm.dachary.org/chroot/debian/x86_64/natty/">x86_64</a>.The
content of the <em>packaging-farm.conf</em> was documented as a manual page:</p>
<div class="highlight"><pre><span></span>NAME
       packaging-farm.conf - define the default environment to build a package


DESCRIPTION
       The  packaging-farm command uses makefiles to run. Each package defines
       variables to influence the way it is built, as described in the packag-
       ing-farm(1)  manual  page.  The  packaging-farm.conf  file  is included
       before the package specific makefile and can be used  to  define  vari-
       ables common to all packages. The packaging-farm.conf is a makefile and
       its syntax depends on GNU make

       There are no default values. If a variable is commented out, it will be
       set to a value that triggers an error.  The default packaging-farm.conf
       file distributed contains sensible defaults, there is no fallback.   If
       they are removed, it is presumably because of a typo or an error and it
       needs to trigger an error instead of silently falling back on an  unex-
       pected default.


VARIABLES
       For  each variable listed below, the values that can be used are listed
       in the comments of the  distributed  packaging-farm.conf  file.  It  is
       important  to  check that a variable does not contain a trailing space.
       Otherwise it will be used and lead to unexpected results.


       DISTRIBUTIONS
          is the white space separated list of distributions for  which  a
          package must be built.


       ARCHITECTURES
          is  the  white space separated list of architectures for which a
          package must be built.  For each DISTRIBUTION, the package  will
          be  built  for  all ARCHITECTURES. For instance if DISTRIBUTIONS
          contains squeeze and maverick and  ARCHITECTURES  contains  i386
          and   x86_64,  the  package  will  be  built  for  squeeze+i386,
          squeeze+x86_64, maverick+i386 and maverick+x86_64.  There is  no
          way  to  ask that only i386 is built for squeeze and only x86_64
          is built for maverick.


       PACKAGES
          The list of the packages for which dependencies must  be  calcu-
          lated with

          packaging-farm depends

          so  that  package1  is  always built before package2 if package2
          depends on package1. It is recommended to not manually set  this
          variable.   Instead,  the  <span class="cp">${</span><span class="n">CACHEDIR</span><span class="cp">}</span>/build  (which  is usually
          /var/cache/packaging-farm/build ) should only  contain  directo-
          ries  matching  the  names  of  the packages to work on. And the
          variable can be set with:

          PACKAGES=$(shell ls <span class="cp">${</span><span class="n">CACHEDIR</span><span class="cp">}</span>/build)


       AUFS   The AUFS File System (http://aufs.sourceforge.net/) is  used  by
          the  packaging  farm  to  create a local copy of a chroot with a
          minimum overhead. If not available (value set  to  no)  a  rsync
          based  copy  will  be  used  instead.  This uses a lot more disk
          space.  On  Debian  GNU/Linux,  aufs  is  usually  available  by
          default and can be loaded with modprobe aufs


       CHROOT_WANTED
          The  list  of  chroot  that must be loaded in order to build the
          packages.   They   are   retrieved    from    rsync://packaging-
          farm.dachary.org/packaging-farm via the command:

          packaging-farm chroot-master-sync

          For instance

          CHROOT_WANTED=debian/i386/squeeze debian/x86_64/squeeze

          will retrieve squeeze for the i386 and x86_64 architectures. The
          chroot repository can be browsed via the web  at  http://packag-
          ing-farm.dachary.org/chroot/.   The  available chroot must cover
          all combinations of the DISTRIBUTIONS  and  ARCHITECTURES  vari-
          ables,  both in the packaging-farm.conf file and in the invivid-
          ual makefiles of each package. For  instance,  if  a  packaging-
          farm.conf  has DISTRIBUTIONS=squeeze ARCHITECTURES=i386 only but
          a package overrides this  with  DISTRIBUTIONS=wheezy  packaging-
          farm will need debian/i386/wheezy to build it.  If the distribu-
          tion is omitted, all chroot for a  given  architecture  will  be
          retrieved.

          packaging-farm CHROOT_WANTED=debian/i386 chroot-master-sync

          A  cron  job will synchronize on a daily basis. There is no need
          to manually run the synchronization, unless a specific update is
          needed immediately.  After being copied, the chroot will get the
          /etc/resolv.conf file from the host.


       CHROOT_ROOT
          Directory in which copies of the CHROOT_WANTED are kept.  As  of
          May, 2011, if CHROOT_WANTED=debian it will use 5GB.


       SUBMIT The suffix of the submit script that will be used when running:

          packaging-farm submit

          The  action  is  carried out by as script named after this vari-
          able.

          /var/lib/packaging-farm/submit/submit-<span class="cp">${</span><span class="n">SUBMIT</span><span class="cp">}</span>.sh


TROUBLESHOOTING
       check for trailing spaces in variable values
          DISTRIBUTIONS=A B with a trailing space is different  from  DIS-
          TRIBUTIONS=A  B  withing a trailing space and will lead to unex-
          pected behavior.


SEE ALSO
       submit-xivo.sh(1), packaging-farm(1)


AUTHORS
       Loic Dachary <span class="nt">&lt;loic</span><span class="err">@dachary.org</span><span class="nt">&gt;</span>



                     local      packaging-farm.conf(5)
</pre></div>


<p>The default <em>packaging-farm.conf</em> file was self documented and set with
defaultvalues so that the user only need to copy/paste from it without a
need to actuallyunderstand the details.</p>
<div class="highlight"><pre><span></span>########################################################################
#
# White space separated list of the distributions for which the packages
# must be built.
# There must be NO SPACE at the end of the line
#
# DISTRIBUTIONS=lenny squeeze wheezy unstable maverick natty
#
DISTRIBUTIONS=unstable
#
########################################################################
#
# White space separated list of the distributions for which the packages
# must be built. 
# There must be NO SPACE at the end of the line
#
# ARCHITECTURES=i386 x86_64
# 
ARCHITECTURES=x86_64
#
########################################################################
#
# The list of the packages for which dependencies must be calculated
# with
#
# packaging-farm depends
#
# so that package1 is always built before package2 if package2 depends
# on package1. It is recommended to not manually set this variable.
# Instead, the <span class="cp">${</span><span class="n">CACHEDIR</span><span class="cp">}</span>/build (which is usually 
# /var/cache/packaging-farm/build ) should only contain directories
# matching the names of the packages to work on.
# There must be NO SPACE at the end of the line
#
# PACKAGES=package1 package2
#
PACKAGES=$(shell ls <span class="cp">${</span><span class="n">CACHEDIR</span><span class="cp">}</span>/build)
#
########################################################################
#
# The AUFS File System (http://aufs.sourceforge.net/) is used by the
# packaging farm to create a local copy of a chroot with a minimum
# overhead. If not available (value set to no) a rsync based copy will
# be used instead. This uses a lot more disk space.
# On Debian GNU/Linux, aufs is usually available by default and
# can be loaded with modprobe aufs
#
#AUFS=yes
AUFS=no
#
########################################################################
#
# The list of chroot that must be loaded in order to build the
# packages. They are retrieved from rsync://packaging-farm.dachary.org/packaging-farm
# For instance:
# CHROOT_WANTED=debian/i386/squeeze debian/x86_64/squeeze 
# will retrieve squeeze for the i386 and x86_64 architectures.
#
# The values are:
#
# debian/i386/lenny
# debian/i386/maverick
# debian/i386/natty
# debian/i386/squeeze
# debian/i386/unstable
# debian/i386/wheezy
# debian/x86_64/lenny
# debian/x86_64/maverick
# debian/x86_64/natty
# debian/x86_64/squeeze
# debian/x86_64/unstable
# debian/x86_64/wheezy
#
# There must be NO SPACE at the end of the line
#
# Retreive all of debian
# CHROOT_WANTED=debian
# Retreive all of i386 debian
# CHROOT_WANTED=debian/i386
# Retreive all of x86_64 debian
# CHROOT_WANTED=debian/x86_64
#
CHROOT_WANTED=debian/x86_64/unstable
#
########################################################################
#
# Directory in which copies of the CHROOT_WANTED 
# are kept.
#
CHROOT_ROOT=/chroot
#
########################################################################
#
# The suffix of the submit script that will be used
# when running:
#
# packaging-farm submit
#
######
# Read man submit-xivo.sh(1) for more information
# SUBMIT=xivo
#####
# Not yet documented.
# SUBMIT=pokersource
#
SUBMIT=none
#
########################################################################
#
# If set, the debsign(1) command will be called to
# sign the package, if it is built successfully.
#
# debsign <span class="cp">${</span><span class="n">SIGN_debian</span><span class="cp">}</span> *.changes
#
# It should specify the key with which the package should be
# signed. The meta-packages will use SIGN_WITH to sign
# the packages.
#
#SIGN_debian=-kABCDEFGH
SIGN_debian=
#
########################################################################
#
# Sign the packages of the repository created for a meta-package
# See reprepro(1) for more information.
#
#SIGN_WITH=SignWith: yes
SIGN_WITH=
#
</pre></div>


</p>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="http://blog.xivo.io/an-alternate-xivo-gallifrey-repository-part-22.html#an-alternate-xivo-gallifrey-repository-part-22">An alternate XiVO gallifrey repository (part 2/2)</a></h2>
    <p>
      Posted on Wed 27 April 2011 in <a href="http://blog.xivo.io/category/xivo-ipbx.html">XiVO IPBX</a>
    </p>
  </header>
  <div>
      <h4>composing gallifrey</h4>
<p>The gallifrey repository is made of packages built from the GIT
repositories, some extracted from the official repository because they
are not under GIT and others built for the occasion (kernel-modules and
meta-packages). The source of each package is documented in
<strong>/var/cache/packaging-farm/build/gallifrey/Makefile</strong> which is the
meta-package that depends on all the others:</p>
<div class="highlight"><pre><span></span><span class="err">#</span><span class="x"></span>
<span class="err">#</span><span class="x"> Submitted from the GIT repositories</span>
<span class="err">#</span><span class="x"></span>
<span class="err">#</span><span class="x"> for dir in asterisk dahdi-linux asterisk-sounds-gsm-de-de asterisk-sounds-wav-en-us asterisk-sounds-wav-es-es asterisk-sounds-wav-fr-ca \</span>
<span class="err">#</span><span class="x">       prompts-xivo prompts asternic-stats agid base-config ctiservers ctiwebclient extra fetchfw \</span>
<span class="err">#</span><span class="x">       lib-python provisioning queues-logger sysconfd utils web-interface ; do packaging-farm DIRECTORY=</span><span class="p">$</span><span class="nv">dir</span><span class="x"> submit ; done</span>
<span class="err">#</span><span class="x"></span>
<span class="err">#</span><span class="x"> Retrieved from dak.proformatique.com because they are not yet in the GIT repositories</span>
<span class="err">#</span><span class="x"> deb-src http://dak.proformatique.com/debian/ lenny-xivo-gallifrey-dev main</span>
<span class="err">#</span><span class="x"> for package in asterisk-chan-capi libasterisk-perl libpri misdn-kernel misdn-user \</span>
<span class="err">#</span><span class="x">                sangoma-wanpipe spandsp pf-xivo pf-xivo-backup  ; \</span>
<span class="err">#</span><span class="x">                do ( rm -fr </span><span class="p">$</span><span class="nv">package</span><span class="x"> ; mkdir </span><span class="p">$</span><span class="nv">package</span><span class="x"> ; cd </span><span class="p">$</span><span class="nv">package</span><span class="x"> ; apt-get source </span><span class="p">$</span><span class="nv">package</span><span class="x"> ) ; done</span>
<span class="err">#</span><span class="x"></span>
<span class="err">#</span><span class="x"> Hand made packages</span>
<span class="err">#</span><span class="x"></span>
<span class="err">#</span><span class="x"> gallifrey</span>
<span class="err">#</span><span class="x"> dahdi-linux-modules</span>
<span class="err">#</span><span class="x"> sangoma-wanpipe-modules</span>
<span class="err">#</span><span class="x"> misdn-kernel-modules</span>
<span class="err">#</span><span class="x"></span>
</pre></div>


<p>The hand made packages (i.e. Makefiles) can be retrieved from their
respective repositories:</p>
<ul>
<li>http://gallifrey.dachary.org/packaging-farm/gallifrey/Makefile</li>
<li>http://gallifrey.dachary.org/packaging-farm/dahdi-linux-modules/Makefile</li>
<li>http://gallifrey.dachary.org/packaging-farm/misdn-kernel-modules/Makefile</li>
<li>http://gallifrey.dachary.org/packaging-farm/sangoma-wanpipe-modules/Makefile</li>
</ul>
<p>Mirroring the http://gallifrey.dachary.org/packaging-farm/ directory is
enough to get all the information required to re-install a
packaging-farm from scratch.</p>
<h4>comparing repositories</h4>
<p>In order to make sure that the new <a href="http://gallifrey.dachary.org/packaging-farm/gallifrey/gnulinux/debian/">gallifrey
repository</a>
does not deviate from the <a href="http://dak.proformatique.com/debian/dists/lenny-xivo-gallifrey-dev/">existing
dak</a>,
the packages it contains were extracted from sources and compared.</p>
<div class="highlight"><pre><span></span><span class="err">#</span><span class="x"> deb-src http://dak.proformatique.com/debian/ lenny-xivo-gallifrey-dev main</span>
<span class="x">dak:</span>
<span class="x">        mkdir -p dak</span>
<span class="x">        apt-get update</span>
<span class="x">        cd dak ; awk &#39;/^Package/</span><span class="err">{</span><span class="x">print </span><span class="p">$$</span><span class="x">2}&#39; /var/lib/apt/lists/dak.proformatique.com_debian_dists_lenny-xivo-gallifrey-dev_main_source_Sources | \</span>
<span class="x">        while read package ; do ( rm -fr </span><span class="p">$$</span><span class="nv">package</span><span class="x"> ; mkdir </span><span class="p">$$</span><span class="nv">package</span><span class="x"> ; cd </span><span class="p">$$</span><span class="nv">package</span><span class="x"> ; apt-get source </span><span class="p">$$</span><span class="nv">package</span><span class="x"> ) ; done</span>

<span class="x">farm:</span>
<span class="x">        rm -fr farm ; mkdir -p farm</span>
<span class="x">        cd farm ; for package in `ls /var/lib/packaging-farm` ; do \</span>
<span class="x">                if [ -f &quot;`echo /var/lib/packaging-farm/</span><span class="p">$$</span><span class="nv">package</span><span class="x">/gnulinux/debian/i386/lenny/src/*.dsc`&quot; ] ; then \</span>
<span class="x">                        ( \</span>
<span class="x">                                mkdir </span><span class="p">$$</span><span class="nv">package</span><span class="x"> ; cd </span><span class="p">$$</span><span class="nv">package</span><span class="x"> ; \</span>
<span class="x">                                dpkg-source -x /var/lib/packaging-farm/</span><span class="p">$$</span><span class="nv">package</span><span class="x">/gnulinux/debian/i386/lenny/src/*.dsc ; \</span>
<span class="x">                        ) \</span>
<span class="x">                fi ; \</span>
<span class="x">        done</span>

<span class="x">diff:</span>
<span class="x">        cd farm ; for package in * ; do \</span>
<span class="x">                if [ -d ../dak/</span><span class="p">$$</span><span class="nv">package</span><span class="x"> ] ; then \</span>
<span class="x">                        farm_dir=`find </span><span class="p">$$</span><span class="nv">package</span><span class="x">/* -maxdepth 0 -type d` ; \</span>
<span class="x">                        dak_dir=`find ../dak/</span><span class="p">$$</span><span class="nv">package</span><span class="x">/* -maxdepth 0 -type d` ; \</span>
<span class="x">                        diff -ur </span><span class="p">$$</span><span class="nv">dak_dir</span><span class="x"> </span><span class="p">$$</span><span class="nv">farm_dir</span><span class="x"> ; \</span>
<span class="x">                else \</span>
<span class="x">                        echo </span><span class="p">$$</span><span class="nv">package</span><span class="x"> not in dak ; \</span>
<span class="x">                fi ; \</span>
<span class="x">        done &gt; /var/www/diff/diff-`date +%Y-%m-%d`.txt</span>
<span class="x">        cd dak ; for package in * ; do \</span>
<span class="x">                if [ ! -d ../farm/</span><span class="p">$$</span><span class="nv">package</span><span class="x"> ] ; then \</span>
<span class="x">                        echo </span><span class="p">$$</span><span class="nv">package</span><span class="x"> not in farm ; \</span>
<span class="x">                fi ; \</span>
<span class="x">        done &gt;&gt; /var/www/diff/diff-`date +%Y-%m-%d`.txt</span>

<span class="x">.PHONY: dak farm</span>
</pre></div>


<p>The result is <a href="http://gallifrey.dachary.org/diff/">archived with a
timestamp</a>.According to Nicolas
Hicher, the numerous SVN tag substitutions that are missing because of
the migration to GIT will be harmless:</p>
<div class="highlight"><pre><span></span><span class="x">pf_magic_pickupmark</span>
<span class="x">-       </span><span class="p">$</span><span class="nv">Revision</span><span class="x">: 10011 </span><span class="p">$</span><span class="x"></span>
<span class="x">-       </span><span class="p">$</span><span class="nv">Date</span><span class="x">: 2011-01-21 17:22:28 +0100 (Fri, 21 Jan 2011) </span><span class="p">$</span><span class="x"></span>
<span class="x">+       </span><span class="p">$</span><span class="nv">Revision</span><span class="p">$</span><span class="x"></span>
<span class="x">+       </span><span class="p">$</span><span class="nv">Date</span><span class="p">$</span><span class="x"></span>
</pre></div>


<h4>packaging-farm release 1.2.39</h4>
<p>A few <a href="http://packaging-farm.dachary.org/#Issue">issues</a> were reported
against the latest packaging-farm, but they were not fixed because they
are not blocking. Other problems required immediate attention and they
were fixed in the <a href="http://packaging-farm.dachary.org/download/">1.2.39</a>
release</p>
<div class="highlight"><pre><span></span>* home/www/packaging-farm/packaging-farm/lib/Makefile:
        kill all processes left over in a chroot before trying to umount
        [dd63f7ecef41] 

        * home/www/packaging-farm/packaging-farm/debian/changelog, home/www
        /packaging-farm/packaging-farm/debian/control, home/www/packaging-
        farm/packaging-farm/lib/Makefile, home/www/packaging-farm/packaging-
        farm/lib/debian/official-op.sh, home/www/packaging-farm/packaging-
        farm/lib/debian/submit.sh, home/www/packaging-farm/packaging-
        farm/lib/kernel-module/depends.sh:
        add support for wheezy
        [8f9a40627f0b]

        * home/www/packaging-farm/packaging-farm/lib/report.sh:
        add support for debian src format 3.0 by recognizing the
        .debian.tar.gz
        [36b30f22e4d8]

        * home/www/packaging-farm/packaging-farm/etc/packaging-farm.conf:
        change the semantic and example of SIGN_debian
        [d3215a3a920f]

        * home/www/packaging-farm/packaging-farm/submit/submit-xivo.sh:
        preserve epoch from version, if any
        [6deaae005d9a]

        * home/www/packaging-farm/packaging-farm/bin/packaging-farm.1:
        document the updating of the chroots and add a section on
        troubleshooting
        [2af56b21eb6a]
</pre></div>


</p>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="http://blog.xivo.io/an-alternate-xivo-gallifrey-repository-part-12.html#an-alternate-xivo-gallifrey-repository-part-12">An alternate XiVO gallifrey repository (part 1/2)</a></h2>
    <p>
      Posted on Mon 18 April 2011 in <a href="http://blog.xivo.io/category/xivo-ipbx.html">XiVO IPBX</a>
      &#8226; Tagged with
      <a href="http://blog.xivo.io/tag/packages.html">packages</a>    </p>
  </header>
  <div>
      <h4>Kernel module dependencies</h4>
<p>When binary kernel modules need to be rebuilt, a Makefile containing
<em>ROLE = kernel-module</em> is created for the packaging-farm to work with,
as explained in the manual page. It depends on the source package
providing the <em>MODULE = module-source</em> package. A script was added to
the global dependency computation facility of packaging-farm</p>
<div class="highlight"><pre><span></span>packaging-farm depends
</pre></div>


<p>to figure out if the source package is known. If it is a dependency, it
is added to the <em>/var/cache/packaing-farm/depends.mk</em> file so that it is
rebuilt before the binary kernel modules.</p>
<h4>Gallifrey dedicated farm.</h4>
<p>A <a href="http://gallifrey.dachary.org/packaging-farm/">dedicated virtual
machine</a> was created to
host the making of gallifrey packages and the resulting repository. It
has been installed from scratch, using the latest
<a href="http://packaging-farm.dachary.org/download/">packaging-farm</a> package.It
turned out that the submission form of <em>submit-xivo.sh(1)</em> relies on
being able to find some dependencies of the source package being
submitted, such as <em>cdbs</em> or <em>quilt</em>. Although the <em>dpkg-buildpackage
-d</em> command is used (which is supposed to be insensitive to the lack of
source dependencies), it could not work unless it is able to interpret
the <em>debian/rules</em> file. The <em>cdbs</em> and <em>quilt</em> dependencies were added
to the packaging-farm package and all general purpose dependencies
should be as well.</p>
<h4>Patching debian configuration</h4>
<p>When something is not right with the debian package, it can be patched
directly on the farm instead of going thru the repository. It may be
useful as a temporary measure when the correct patch is still unclear.</p>
<div class="highlight"><pre><span></span>cd /var/cache/packaging-farm/sources/PACKAGE
# fix something in PACKAGE/debian/rules
dpkg-source -b PACKAGE
</pre></div>


<p>Note that once the fix is correct, it must be saved because the sources
will be overriden when</p>
<div class="highlight"><pre><span></span>packaging-farm DIRECTORY=PACKAGE submit
</pre></div>


<p>is run.This method was used to produce patches for
<a href="https://projects.proformatique.com/issues/2194">asterisk</a>,
<a href="https://projects.proformatique.com/issues/2195">dahdi-linux</a> and
<a href="https://projects.proformatique.com/issues/2196">dahdi-tools</a>.</p>
<h4>Configuring packaging-farm</h4>
<p>In order for the packages to be signed, a GPG key is generated, without
a password and added tothe <em>packaging-farm.conf</em> file (see below
SIGN_debian=-kD08ED067 )</p>
<div class="highlight"><pre><span></span>gpg --gen-key
</pre></div>


<p>The <em>/etc/packaging-farm/packaging-farm.conf</em> was modified for
<em>gallifrey</em> as follows:</p>
<div class="highlight"><pre><span></span>#
# Exclusively built for lenny
#
DISTRIBUTIONS=lenny
#
# Exclusively built for i386
#
ARCHITECTURES=i386
#
# Source submission porcess configuration
#
SUBMIT=xivo
#
# gallifrey only ships for lenny
#
export SUITE=lenny
export XIVO=gallifrey
#
# List of subdirectories of CHROOT_SOURCE that are cached
# localy in CHROOT_ROOT on a daily basis with
# packaging-farm chroot-master-sync
#
CHROOT_WANTED=debian/i386/lenny
#
# Signing related options for Debian GNU/Linux
# See dpkg-buildpackage(1) for more information
#
SIGN_debian=-kD08ED067
#
# Signing related options for Debian GNU/Linux
# See reprepro(1) for more information
#
SIGN_WITH=SignWith: yes
</pre></div>


<h4>Collecting gallifrey modules.</h4>
<p>The <em>gallifrey</em> sources and debian packages are to be found in the
following repositories:</p>
<div class="highlight"><pre><span></span>http://git.xivo.fr/xivo-gallifrey.git/ sources
http://git.xivo.fr/debian/lenny-xivo-gallifrey.git/ debian packages
</pre></div>


<p>And the following were submitted :</p>
<div class="highlight"><pre><span></span><span class="x">for dir in dahdi-linux asterisk-sounds-gsm-de-de asterisk-sounds-wav-en-us asterisk-sounds-wav-es-es asterisk-sounds-wav-fr-ca prompts-xivo prompts asternic-stats agid base-config ctiservers ctiwebclient extra fetchfw lib-python provisioning queues-logger sysconfd utils web-interface ; do packaging-farm DIRECTORY=</span><span class="p">$</span><span class="nv">dir</span><span class="x"> submit ; done</span>
</pre></div>


<p>However, some of them were rebuilt manually:</p>
<div class="highlight"><pre><span></span>dahdi-linux-modules libasterisk-perl libpri misdn-kernel misdn-kernel-modules pf-asterisk-prompt-fr-xivo pf-xivo pf-xivo-backup sangoma-wanpipe sangoma-wanpipe-modules spandsp
</pre></div>


<p>and must be retrieved from the development repository:</p>
<div class="highlight"><pre><span></span><span class="k">deb-src</span> <span class="s">http://dak.proformatique.com/debian/</span> <span class="kp">lenny-xivo-gallifrey-dev</span> <span class="kp">main</span>
</pre></div>


<p>using the method laid out in the <a href="http://blog.xivo.fr/index.php?post/2011/02/21/Creating-an-independant-XiVO-Debian-GNU/Linux-repository-from-scratch-%28part-3%29">Creating an independant XiVO Debian
GNU/Linux repository from
scratch</a>
series.At the moment the development repository is incomplete. But it is
being worked on and the making of the repository will resume when it is
back online.</p>
</p>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="http://blog.xivo.io/signing-and-naming-xivo-packages.html#signing-and-naming-xivo-packages">Signing and naming XiVO packages</a></h2>
    <p>
      Posted on Mon 11 April 2011 in <a href="http://blog.xivo.io/category/xivo-ipbx.html">XiVO IPBX</a>
      &#8226; Tagged with
      <a href="http://blog.xivo.io/tag/packages.html">packages</a>    </p>
  </header>
  <div>
      <h4>signing packages</h4>
<p>A GPG
<a href="http://packaging-farm.dachary.org/download/packaging-farm.gpg">key</a> was
created for <a href="http://packaging-farm.dachary.org">packaging-farm</a> and used
to sign the <a href="http://packaging-farm.dachary.org/downloads/">1.2.37</a>
release. It can be imported using:</p>
<div class="highlight"><pre><span></span>curl http://packaging-farm.dachary.org/download/packaging-farm.gpg | sudo apt-key add -
</pre></div>


<p>Two variables were added to the packaging-farm configuration file to
instruct dpkg-buildpackage and repreprothat they must sign the packages
and repositories.If the GPG private key for the packager (as listed in
the debian/changelogfor instance) is found (in the home of the user
building the package)and that SIGN_debian is provided the packages will
be signed with it.The relevant packaging-farm.conf(5) lines are:</p>
<div class="highlight"><pre><span></span>#
# Signing related options for Debian GNU/Linux
# See dpkg-buildpackage(1) for more information
#
SIGN_debian=-k840233
</pre></div>


<p>If the GPG private key for the packager (as listed in the
debian/changelogfor instance) is found (in the home of the user building
the packages)and that SIGN_WITH is set the packages and the content of
the repository will be signed with it.The relevant
packaging-farm.conf(5) lines are:</p>
<div class="highlight"><pre><span></span>#
# Signing related options for Debian GNU/Linux
# See reprepro(1) for more information
#
#SIGN_WITH=SignWith: yes
SIGN_WITH=
</pre></div>


<h4>packages versioning</h4>
<p>The package version policy as found in the proformatique internal wiki
is:</p>
<h3>Packages Externes</h3>
<p>La source pourra être Debian ou n'importe quel autre source fiable de
ports et backports.Le nom du package devra rester identique à la version
originelle.Nos uploads seront considérés comme des NMU, et le sufixe
utilisé pour la version du package sera selon les cas :</p>
<ul>
<li>+pf.&lt;n&gt; : packages généraux ne faisant partie d'aucun projet
    (&lt;n&gt; étant la révision Proformatique pour la même
    version Debian)</li>
<li>+pf.&lt;project&gt;.&lt;ver&gt; : packages contenant des correctifs
    ou améliorations <em>'spécifiques</em>' à un projet, comme xivo / eyefar
    / ... (&lt;project&gt; étant le nom du projet commercial et
    &lt;ver&gt; la version du projet (et pas du composant en question))</li>
</ul>
<p>Dans d'un sufixe contenant une version qui n'est pas finale, il faut
rajouter l'information de révision (SVN par exemple) de cette façon
:.&lt;project&gt;.&lt;ver&gt;\~&lt;rev&gt; (avec &lt;ver&gt; la version
de la dernière release / branche stable, et &lt;rev&gt; du style "svn42"
/ "baz42" / "rc3" / ...)Examples :</p>
<ul>
<li>1.6.8p12-4 -&gt; 1.6.8p12-4+pf.1, puis 1.6.8p12-4+pf.2, ...</li>
<li>1.6.8p12-4 -&gt; 1.6.8p12-4+pf.xivo.0.5, puis
    1.6.8p12-4+pf.xivo.0.5<a></a>svn103</li>
<li>(cas d'une nouvelle version upstream) 1.6.8p12-4 -&gt;
    1.6.10-0+pf.1, ...</li>
</ul>
<h3>Packages Proformatique</h3>
<p>Nous n'utiliserons pas de packages natifs, vu que ce ne seront
généralement pas les même personnes qui feront la dev et le packaging.
Les données de packaging pourront cependant être mis dans un RCS séparé
si besoin.Le nom du package suivra la forme : pf-&lt;project/usage&gt;
(avec &lt;project&gt; le nom du projet éventuellement suivi du
sous-projet : &lt;project&gt;-&lt;subproject&gt;, ou &lt;usage&gt; pour
un usage spécifique comme les meta-packages)La version suivra la forme :
&lt;ver&gt;-&lt;debver&gt; ou &lt;ver&gt;\~&lt;rev&gt;-&lt;debver&gt;
(avec &lt;ver&gt; et &lt;rev&gt; comme pour les packages externes)Par
exemple paquet <em>pf-xivo-web-interface</em> version <em>1.2.3\~svn123-1</em> pour du
developpement ou <em>1.2.3-1</em> pour une release.Le Maintainer du package
sera : <em>Proformatique Maintainance Team
&lt;technique@proformatique.com&gt;</em>On ajoutera dans les Uploaders la
liste de toutes les personnes attachées à son entretient.</p>
<h3>implementation in submit-xivo.sh</h3>
<p>After discussions with Nicolas Hicher and Sylvain Boily, the package
version numbers produced by
<a href="http://packaging-farm.dachary.org/packaging-farm/packaging-farm/submit/submit-xivo.sh">submit-xivo.sh</a>
must start with the upstream version and ends with a version number
computed from the date and a mercurial hash. It is computed for packages
for which a *-VERSION file found in the corresponding <a href="http://git.xivo.fr/xivo-skaro.git/">source
directory</a>.</p>
</p>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="http://blog.xivo.io/introduction-to-the-plugin-model-of-the-new-provisioning-server.html#introduction-to-the-plugin-model-of-the-new-provisioning-server">Introduction to the plugin model of the new provisioning server</a></h2>
    <p>
      Posted on Mon 11 April 2011 in <a href="http://blog.xivo.io/category/software.html">Software</a>
      &#8226; Tagged with
      <a href="http://blog.xivo.io/tag/xivo-12.html">xivo 1.2</a>,      <a href="http://blog.xivo.io/tag/provisioning.html">provisioning</a>    </p>
  </header>
  <div>
      <p>What must be understood is that if you install provd but you do not
install any plugins, the server won't be able to configure anything.
This means that without plugins, provd is pretty useless.</p>
<p>Each plugin can configure devices from configuration specifications.
Plugins can also offer some additional services, like the downloading of
external files, like firmware or dictionary files for example. So what
was done before by xivo_fetchfw is now partially integrated in each and
every plugin.</p>
<p>One important particularity of this system is that each plugin is
isolated from the others. Besides, and unlike the old provisioning
server, the plugins doesn't share a common directory like /tftpboot.
This way, there's never a conflict between the files used by the
different plugins, and this make it easy to have for example a
xivo-aastra-3.2.0.1011 and a xivo-aastra-2.6.0.2019 plugin on the same
server.</p>
<p>This means that with provd, you can have at the same time and on the
same network, for example, two Aastra 6730i, one using the 2.6.0.2019
firmware and another using the 3.2.0.1011 firmware, and this using the
same DHCP server configuration for the two devices. From the point of
view of both devices, their firmware will be located at
http://&lt;provd_ip&gt;/6730i.st, but for one, this will be a firmware
in version 2.6.0.2019, and for the other, a firmware in version
3.2.0.1011. And if you are curious and point your web browser to this
URL, you'll get an error 404 !</p>
<p>We must know that provd, unlike the old provisioning server, doesn't
depend on an external HTTP/TFTP server to process the requests, since it
handles these requests by itself. This was becoming necessary with the
introduction of the plugin system and the 'dynamic' request processing.</p>
<p>Now, if you are a mentally sane person, you might be asking yourself if
this whole system is based on sound principles. And I have a good news
for you; you are not insane, this system is not based on sound
principles <em>a priori</em>.</p>
<p>In fact, for this system to becomes reliable, a precondition must be
true: for each request, it should be possible to unambiguously identify
which device is behind it. With this unambiguous information available,
we can then lookup in our device database for the complete information
we have on this device, and then find which plugin should handle the
request, and redirect the request to this plugin.</p>
<p>The good thing about this is that most devices provide this unique
information. For example, the Aastras send their MAC address in the
User-Agent header of each HTTP request they make.</p>
<p>That said, some device doesn't give as much information, like the Cisco
7900, which can only do TFTP requests. This means that sometimes, and
only for some requests, the only 'unique' information we can extract
from a request is the IP address. This does not generally cause problem,
except if you are constantly changing the IP addresses on your network.
And if you enable the provd-DHCP server integration, it will make sure
that the MAC-IP association is always up to date, and this means the
system will be reliable once again.</p>
<p>So, part of provd is only about making this system reliable and finely
tunable if there's any need to fine-tune the behaviour of the system.
And to make thing a bit more clear, here's a high level view of what
happens when an HTTP request is made to the provisioning server:</p>
<p><a href="/public/provd/provd-http-request-flow.png" title="Example HTTP request flow"><img alt="Example HTTP request
flow" src="/public/provd/.provd-http-request-flow_m.jpg" title="Example HTTP request flow, avr. 2011" /></a></p>
<ol>
<li>An Aastra 6730i using firmware 2.6.0.2019, with MAC
    XX:XX:XX:XX:XX:XX and IP Y.Y.Y.Y, does an HTTP GET request for
    /aastra.cfg to the provd server</li>
<li>The HTTP server component in provd receive the request. It then
    sends it to the 'request processing' component. Note that TFTP
    requests are also being processed by the request
    processing component.</li>
<li>The first step in the request processing is to extract information
    from the request. The goal is to extract the maximum of information
    about the device behind the request, like its MAC address, model,
    vendor, firmware version, serial number, IP address, etc. By
    default, each plugin can participate in this step. In this case, at
    the end of this step, we know that the request comes from an Aastra
    6730i in version 2.6.0.2019, that its MAC address is
    XX:XX:XX:XX:XX:XX and its IP address is Y.Y.Y.Y.</li>
<li>The second step in the request processing is to retrieve the device
    from the device database using the information extracted at 3. In
    this case, we suppose there was already a device with MAC
    XX:XX:XX:XX:XX:XX in the device database, so we retrieve it.</li>
<li>The third step is to update the retrieved device using the
    extracted information. For example, we can update information we
    didn't know about the device. We can also do generic operation in
    this step if we needs to. Anyway, in our case, this step is actually
    a no-op.</li>
<li>The last step is to route the request to the HTTP handler that will
    answer the request. In our case, from the device retrieved at 4, we
    know that its associated plugin is xivo-aastra-2.6.0.2019, so the
    request is routed to the HTTP handler of the
    xivo-aastra-2.6.0.2019 plugin.</li>
<li>Finaly, the handler chosen at 6 answer the request. In this case,
    the xivo-aastra-2.6.0.2019 plugin will return the content of its
    var/tftpboot/aastra.cfg file.</li>
</ol>
<p>Now, you might be wondering how this work when an unknown device make a
request to the provisioning server. By default, at step 4, if no device
can be found in the database, a new one is added.</p>
<p>Then, at step 5, if a device has no plugin associated to it, an
automatic device association process occurs. Also at this step, a device
with no config associated to it can have a default config associated to
it. So, at the end of step 5, we then have a device with a default
config and an associated plugin although the device was not known from
the provisioning server when the request was received.</p>
<p>So this is what conclude our brief introduction to the plugin model of
the new provisioning server. If you are interested into digging into the
details, you might want to start by looking at the
provd/devices/ident.py python source file (this make me thing I should
rename this file) and the various *.py.conf.* configuration file.</p>
<p>Note that to keep this text at the introduction level, some things
stated here have been slightly simplified and are not 100% exact.</p>
</p>
  </div>
</article>

  <div class="pagination">
    <a class="btn" href="http://blog.xivo.io/index30.html">
      <i class="fa fa-angle-left"></i> Older Posts
    </a>
      <a class="btn float-right" href="http://blog.xivo.io/index28.html">
        Newer Posts <i class="fa fa-angle-right"></i>
      </a>
  </div>

    <footer>
<p>
  &copy; XiVO developers 2015 - This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Create Commons Attribution-ShareAlike 4.0 International License</a>
</p>
<p>Built using <a href="http://getpelican.com" target="_blank">Pelican</a> - <a href="https://github.com/alexandrevicenzi/flex" target="_blank">Flex</a> theme by <a href="http://alexandrevicenzi.com" target="_blank">Alexandre Vicenzi</a></p><p>
  <a rel="license"
     href="http://creativecommons.org/licenses/by-sa/4.0/"
     target="_blank">
    <img alt="Creative Commons License"
         title="Creative Commons License"
         style="border-width:0"
         src="https://i.creativecommons.org/l/by-sa/4.0/80x15.png"
         width="80"
         height="15"/>
  </a>
</p>    </footer>
  </main>
<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " XiVO Blog ",
  "url" : "http://blog.xivo.io",
  "image": "public/xivo-logo.png",
  "description": ""
}
</script></body>
</html>