<!DOCTYPE html>
<html lang="en">
<head>
  <link href='//fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,700,400italic' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" type="text/css" href="http://blog.xivo.io/theme/css/style.min.css">
  <link rel="stylesheet" type="text/css" href="http://blog.xivo.io/theme/css/pygments.min.css">
  <link rel="stylesheet" type="text/css" href="http://blog.xivo.io/theme/css/font-awesome.min.css">
  <link href="http://blog.xivo.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="XiVO Blog Atom">
  <link rel="shortcut icon" href="/public/favicon.ico" type="image/x-icon">
  <link rel="icon" href="/public/favicon.ico" type="image/x-icon">

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="" />
  <meta name="author" content="XiVO developers" />
  <meta name="description" content="" />
<meta property="og:site_name" content="XiVO Blog"/>
<meta property="og:type" content="blog"/>
<meta property="og:title" content="XiVO Blog"/>
<meta property="og:description" content=""/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content="http://blog.xivo.io"/>
<meta property="og:image" content="public/xivo-logo.png">
  <title>XiVO Blog</title>
</head>
<body>
  <aside>
    <div>
      <a href="http://blog.xivo.io">
        <img src="public/xivo-logo.png" alt="" title="">
      </a>
      <h1><a href="http://blog.xivo.io"></a></h1>
      <p></p>
      <nav>
        <ul class="list">
          <li><a href="http://xivo.io" target="_blank">XiVO.io</a></li>
          <li><a href="http://documentation.xivo.io" target="_blank">Documentation</a></li>
        </ul>
      </nav>
      <ul class="social">
        <li><a class="sc-twitter" href="http://twitter.com/xivodevteam" target="_blank"><i class="fa fa-twitter"></i></a></li>
        <li><a class="sc-github" href="http://github.com/xivo-pbx" target="_blank"><i class="fa fa-github"></i></a></li>
        <li><a class="sc-facebook" href="https://www.facebook.com/XiVO-86529730831" target="_blank"><i class="fa fa-facebook"></i></a></li>
      </ul>
    </div>
  </aside>
  <main>
    <nav>
      <a href="http://blog.xivo.io">Home</a>
      <a href="/categories.html">Categories</a>
      <a href="/archives.html">Archives</a>
      <a href="http://blog.xivo.io/feeds/all.atom.xml">Atom</a>
    </nav>

<article>
  <header>
    <h2><a href="http://blog.xivo.io/test-vectors-for-smbus-packet-error-checking-pec-crc-8.html#test-vectors-for-smbus-packet-error-checking-pec-crc-8">Test vectors for SMBus Packet Error Checking (PEC) CRC-8</a></h2>
    <p>
      Posted on Tue 09 October 2012 in <a href="http://blog.xivo.io/category/hardware.html">Hardware</a>
    </p>
  </header>
  <div>
      <p>While implementing the SMBus on the MSP430 (see also the post "<a href="index.php?post/2012/09/29/An-engineering-story">An
engineering story</a>"), I
have been looking for SMBus
<a href="http://en.wikipedia.org/wiki/System_Management_Bus#Packet_Error_Checking" title="PEC"><abbrev title="Packet Error Checking">PEC</abbrev></a>
CRC-8 test vectors but could not find any.</p>
<p>A CRC is a <a href="http://en.wikipedia.org/wiki/Cyclic_redundancy_check">Cyclic Redundancy
Check</a>. It is a
little piece of data typically added at the end of a packet and used to
check with an high reliability that no unintended error occurred during
transmission (or storage). The math to do the computation and the check
of a CRC is not very complicated and can be explained to anybody who
knows how to do a <a href="http://en.wikipedia.org/wiki/Long_division">long
division</a>. The polynomial
for the SMBus PEC CRC-8 is x**8+x**2+x**1+1 -- this is a
polynomial in GF(2), but you don't really have to understand that part
to be able to use CRCs in practice. It corresponds to the binary number
100000111, to be used in a particular way. The following text explains
it better than I could:
<a href="http://www.ross.net/crc/download/crc_v3.txt" title="http://www.ross.net/crc/download/crc_v3.txt">http://www.ross.net/crc/download/cr...</a></p>
<p>I made my own SMBus PEC CRC-8 test vectors (attached to this post). The
format is one test vector per line, like:</p>
<p>TV(616263, 5F)</p>
<p>616263 is the 3-byte message in hexadecimal ("abc" in ASCII). The
resulting one byte CRC-8 in hex is 5F.</p>
<p>The test vectors are checked with an official <a href="http://smbus.org/faq/crc8Applet.htm">Java applet from
smbus.org</a>. They include at the
beginning the result for each one byte packet, which is also the table
for the fast byte based implementation: CRC = table[CRC \^ byte]
(because the initial value to use for CRC is zero), On the MSP430, this
implementation should run in something like 9 cycles per byte when
dropped in the right place. (xor CRC, Rm /* 3 cycles */; mov
table[Rm], CRC; /* 6 cycles */)</p>
</p>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="http://blog.xivo.io/an-engineering-story.html#an-engineering-story">An engineering story</a></h2>
    <p>
      Posted on Sat 29 September 2012 in <a href="http://blog.xivo.io/category/hardware.html">Hardware</a>
    </p>
  </header>
  <div>
      <p>To be able to track interesting quality metrics of our upcoming XiVO
Office product (XiVO IPBX Open Hardware project), we have decided to add
temperature sensors to our current XIOH pcb.</p>
<p>In computers, the typical way to report the temperature to the main
operating system is through SMBus. This is suitable in our case: we
already have an MSP430 microcontroller that handles the power sequence
and is connected to the SMBus of the board. We will connect some diodes
to the MSP430 to measure the temperature. So the time has come to make
use of the SMBus between the MSP and the EP80579 (our main System On
Chip), for temperature measurements and also other purposes.</p>
<p>The MSP430 does not have a full featured SMBus controller, only a
generic I2C one. SMBus is a variant of I2C, with additional electrical
and timing constraints in the physical layer and definition of the
messages at the network layer level.</p>
<p>Although formatting and parsing SMBus messages is easy, properly using
the I2C controller of the MSP430 in a multi-master environment is not
without pitfalls, even if we did not care about the SMBus timing
constraints. To do it with the needed reliability, it is necessary to
have a detailed knowledge of the whole system and to take into
consideration all kind of interactions on the bus and in the chips. In
our business, the reliability wanted by the customers is typically high
enough that it makes sense to build robust systems instead of rushing a
collapsing sandcastle to market. Plus, in that particular case, we are
dealing with the subsystem that brings and keeps the whole board
running, and for which the cost to debug in the field is absurdly high.</p>
<p>All complex chips come with various design errors, and the MSP430 is no
exception. On the exact version that we use, there are 6 documented
errors affecting the I2C controller, of which 4 clearly apply to our
board, 1 clearly does not apply, and one required careful system
analysis to determine that the preconditions to this erroneous behavior
could not happen in our system.</p>
<p>On top of the 4 errata applying to the I2C controller, we have to deal
with errata for other parts of the MSP430, plus some detailled aspects
that are not errata but are also limiting the way we can make a reliable
use of the chip for the tasks we want.Failure to properly take all those
details into consideration would lead to eventual faults of various
natures, probably including MSP430 crashes impossible to diagnose and
leading to spurious shutdowns, systems stuck in the powered state, or
any random behavior and degradation of system functions.</p>
<p>The impact could be full-scale, with potential consequences on:
availability, maintainability, safety, security, and reliability!</p>
<p>It is worthwhile to note that one of the errata that could have the
biggest consequences can only be handled by using one specific software
architecture to drive the I2C controller, and that specific software
architecture is not the first thing that comes to mind in our
preexisting firmware. This is a case where iteration on the design of
the I2C code would have meant its complete rewrite.</p>
<p>Complex systems, even moderately so, need a careful design, especially
on components that are critical for business or technical reasons.
Wishful thinking never produces high reliability and neither does
excessive reliance on luck. Modeling, even informally, sometimes pays.</p>
</p>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="http://blog.xivo.io/let-us-cross-rivers-or-how-the-dev-team-learns-to-bring-about-major-changes-to-xivos-architecture-the-agile-way.html#let-us-cross-rivers-or-how-the-dev-team-learns-to-bring-about-major-changes-to-xivos-architecture-the-agile-way">Let us cross rivers or how the dev team learns to bring about major changes to XiVO's architecture, the agile way.</a></h2>
    <p>
      Posted on Mon 17 September 2012 in <a href="http://blog.xivo.io/category/software.html">Software</a>
    </p>
  </header>
  <div>
      <p>XiVO has been around for over five years now and its use has greatly
evolved since then. From small installations of a few users, XiVO
evolved to support installations of hundreds of users and more recently
major contact centers. We now see XiVO installations with a few
thousands of users, multiple agents, queues and contexts and call
volumes ever increasing. This growth has brought the XiVO dev team new
challenges concerning the architecture of XiVO as not all parts of XiVO
were ready for this kind of sollicitation. We knew it. We knew there
were some bottlenecks we would need to adress.</p>
<p>We are agile and this means, among other things, that we do not build
bridges before we need to cross rivers. Now we're there. We need a
bridge! The XiVO dev team has been working hard in the last months to
overcome some of the major challenges of XiVO.</p>
<p>One of these challenges is linked with the decentralized/multi-component
nature of XiVO. Indeed as you can read in an <a href="/index.php?post/2012/06/11/XiVO-Architecture">older
post</a>, XiVO is a rich
multi-component ecosystem with way too many inter-relations. This has
been a work in progress for a while now were the mission is to reduce
the number of inter-relations as much as possible by better defining
each component's jurisdiction.</p>
<p>We recently had to tackle a very specific challenge where XiVO's use of
Asterisk's AMI could disrupt basic telephony (A calls B). For people who
don't know, AMI stands for Asterisk Manager Interface and is an Asterisk
component allowing custom clients to connect and interact with Asterisk
via a socket. In the XiVO ecosystem, the CTI daemon (CTId) is the major
consumer of Asterisk's AMI. The CTId is a monothreaded python daemon
responsible of handling XiVO client connections. The more users on a
given XiVO installation, the more XiVO clients can potentially connect
to the CTId and thus, the more traffic the CTId exchanges with the AMI.
This traffic can be quite impressive when considering a XiVO
installation under heavy telephony load. The CTId's event loop is a
synchronous blocking loop and while in this loop, the CTId cannot handle
any other jobs. This weakness would not be so terrible if the CTId
wasn't doing anything else than handling XiVO clients connections as it
would only impact those connections and nothing else. This specific
issue is still a major one and we'll adress how we handled it in a later
post.</p>
<p>Now if you remember the <a href="/public/xivosoft/xivo_architecture.png">schema of XiVO's
architecture</a> in our <a href="/index.php?post/2012/06/11/XiVO-Architecture">previously
cited post</a>, you can see
an interconnection between the CTId and the AGI. This relation handled
mainly the reverse directory lookups, used to display a callerID of
incoming call matching a number in a directory. Now this was a major
issue as it meant that any calls passed while the CTId was 'blocked' at
handling AMI traffic would not go through: A cannot call B anymore!</p>
<p>This was not much of an issue when a typical XiVO installation was
populated with a few users as it almost never happened that calls would
be blocked because of reverse directory lookups (or happened not often
enough for users to even notice and signal the issue). With growing XiVO
installations, it became obviously disruptive.</p>
<p>The solution was to remove anything from the CTId that could impact
telephony. From this perspective, any calls to the AGI in the CTId where
moved to nothing else than the AGId, the daemon responsible for handling
communications with Asterisk's AGI. It seems quite obvious when you
think of it and one might ask Why oh why was it not already that way? An
ever evolving XiVO dev team with five years at developping XiVO,
learning a whole lot along the way has to be the only responsible
answer.</p>
<p>XiVO is becoming more mature every day and so is its development team,
producing a software ecosystem always stronger, more mature and more
robust. We love building bridges, bring in the rivers!</p>
</p>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="http://blog.xivo.io/showing-off-xiohv5-prototype-pcb-in-its-laser-cut-acrylic-case.html#showing-off-xiohv5-prototype-pcb-in-its-laser-cut-acrylic-case">Showing off XIOHv5 prototype PCB in its laser cut acrylic case</a></h2>
    <p>
      Posted on Mon 03 September 2012 in <a href="http://blog.xivo.io/category/hardware.html">Hardware</a>
    </p>
  </header>
  <div>
      <p><strong>Please dear XIOH followers, as we approach the production of our final
PCB, we have tried the PCB in an orange laser cut acrylic case.</strong></p>
<p>Below you can discover the front view of the casing with our famous
analog vintage Socotel S63 phone</p>
<p><img alt="XIOHv5 orange case
front" src="/public/XIOHv5/.20120903_194503_m.jpg" title="XIOHv5 orange case front, sept. 2012" /></p>
<p>You can discover also the back view with all the interfaces of our
appliance (2 usb, 3 GbE, 4 ISDN T0, FXS, FXO) :</p>
<p><img alt="XIOHv5_orange_case_back" src="/public/XIOHv5/.20120903_194314_m.jpg" title="XIOHv5_orange_case_back, sept. 2012" /></p>
<p><strong>For those who are willing to discover our latest prototype during
live-demos, we will be at :</strong></p>
<ul>
<li>Astricon2012 (Atlanta - 23-25/10/2012) : presenting XiVO Software
    and hosting a booth</li>
<li>Hackfest 2012 (http://www.hackfest.ca/) : we will be using our XiVO
    IPBX OpenHardware during some hacking contest related to VoIP</li>
</ul>
</p>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="http://blog.xivo.io/xioh-prototype-version-5-back-from-factory.html#xioh-prototype-version-5-back-from-factory">XIOH prototype version 5: back from factory</a></h2>
    <p>
      Posted on Wed 22 August 2012 in <a href="http://blog.xivo.io/category/hardware.html">Hardware</a>
    </p>
  </header>
  <div>
      <h2>Feedback of the factory</h2>
<p>In order to load the factory's pick-and-place machines (2 distinct ones
were used to assemble bottom, then top, then throug-hole components), we
needed an efficient way of sorting the components. Therefore, we created
a database of the correspondence between our BOM and the stickers used
by the factory to load the feeders. See below for an example of one
sticker for one reference used on the top layer.</p>
<p><img alt="XIOHV5_PCB_STICK_EX" src="/public/XIOHv5/.P1050993_m.jpg" title="XIOHV5_PCB_STICK_EX, août 2012" /></p>
<p>Once all the components were ready and sorted out, they were ready to be
carried at the factory for loading and assembling.</p>
<p><img alt="XIOHV5_COMPONANTS_READY" src="/public/XIOHv5/.20120723_001_m.jpg" title="XIOHV5_COMPONANTS_READY, août 2012" /></p>
<p>As an automatic machine geek, the best part was the loading and
pick-and-place of the several ICs on the board. This part is quite
impressive because of the efficiency of the placing. Afterwards, the PCB
goes through an oven for 10minutes for the final soldering, then cools
down prior to the manual assembly of the through-holes components.</p>
<p>Below is a picture with the various IC packages we are using (CPU, ISDN,
FXO/FXS, micro-controllers...)</p>
<p><img alt="XIOHV5_LOADING_ICS" src="/public/XIOHv5/.20120725_005_m.jpg" title="XIOHV5_LOADING_ICS, août 2012" /></p>
<p>We then prepared the through-holes to be manually assembled by the
factory operators, with a schematic of each component in the best order
to respect the mechanical constraints.</p>
<p><img alt="XIOHV5_THROUGH_HOLES" src="/public/XIOHv5/.20120725_013_m.jpg" title="XIOHV5_THROUGH_HOLES, août 2012" /></p>
<p>The assembling of those throug-holes components can take up to 30minutes
for complex boards. It has to be checked when there are a lot of
connectors (for instance) on a board. The ready-to-test boards were then
placed on shelves for us to start our debugging.</p>
<p><img alt="XIOHV5_MOUNTING_THOLES" src="/public/XIOHv5/.20120725_012_m.jpg" title="XIOHV5_MOUNTING_THOLES, août 2012" /></p>
<p>The first batch of tests was done with 5 of the 50 PCBs in order for us
to start the debugging in our lab.</p>
<h2>Debugging the PCBs</h2>
<p>Back to our lab, we were able to start the testing our boards. We did
the following steps in-order:</p>
<ul>
<li>smoke test: testing the power-supply using current-limited power
    supplies for each voltage level, on a special board without the CPU
    assembled (in order to save one in case of short-circuit on
    the board.)</li>
<li>flashing the board with our firmwares (programming the
    power-sequence in an MSP430 and a BIOS in an SPI flash.) This
    validates the flashing method and flashing tools/cables.</li>
<li>booting-up the CPU and testing the serial console</li>
<li>RAM testing: this validates the calibration and initialization of
    the DDR2 controller by our custom firmware.</li>
<li>SATA testing: to be able to start the hard drive and the kernel
    image after the complete BIOS boot sequence</li>
<li>testing the telco interfaces and phone call features.</li>
</ul>
<p><img alt="XIOHV5_DEBUG_BOARD" src="/public/XIOHv5/.P1050995_m.jpg" title="XIOHV5_DEBUG_BOARD, août 2012" /></p>
<p>Above is our main whiteboard listing the issues we have on each PCB, and
how to fix those. This is the most exciting (though stressful) part of
hardware development, as we were able to make progress and get results
in a very short time. We were extastic when we got the first board fully
working with the XiVO software running on it!</p>
<h2>Final tests</h2>
<p>The rest is mainly software: we got XiVO running with our kernel drivers
and plan to do some stress testing to see how well our boards fare with
time and use.</p>
<p><img alt="XIOHV5_FULL_RUNNING" src="/public/XIOHv5/.20120802_001_m.jpg" title="XIOHV5_FULL_RUNNING, août 2012" /></p>
<h2>Next steps</h2>
<p>The next steps:</p>
<ul>
<li>finishing the production of the the first 50 PCB batch and start a
    full 4-weeks time period of stress testing on our board to identify
    potential hardware/software bugs,</li>
<li>validating the hardware and software,</li>
<li>optimizing the production process for the next batches</li>
</ul>
<p>To be continued soon...</p>
<p>The XiVO Open Hardware team.</p>
</p>
  </div>
</article>

  <div class="pagination">
    <a class="btn" href="http://blog.xivo.io/index15.html">
      <i class="fa fa-angle-left"></i> Older Posts
    </a>
      <a class="btn float-right" href="http://blog.xivo.io/index13.html">
        Newer Posts <i class="fa fa-angle-right"></i>
      </a>
  </div>

    <footer>
<p>
  &copy; XiVO developers 2015 - This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Create Commons Attribution-ShareAlike 4.0 International License</a>
</p>
<p>Built using <a href="http://getpelican.com" target="_blank">Pelican</a> - <a href="https://github.com/alexandrevicenzi/flex" target="_blank">Flex</a> theme by <a href="http://alexandrevicenzi.com" target="_blank">Alexandre Vicenzi</a></p><p>
  <a rel="license"
     href="http://creativecommons.org/licenses/by-sa/4.0/"
     target="_blank">
    <img alt="Creative Commons License"
         title="Creative Commons License"
         style="border-width:0"
         src="https://i.creativecommons.org/l/by-sa/4.0/80x15.png"
         width="80"
         height="15"/>
  </a>
</p>    </footer>
  </main>
<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " XiVO Blog ",
  "url" : "http://blog.xivo.io",
  "image": "public/xivo-logo.png",
  "description": ""
}
</script></body>
</html>