<!DOCTYPE html>
<html lang="en">
<head>
  <link href='//fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,700,400italic' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" type="text/css" href="http://blog.xivo.io/theme/css/style.min.css">
  <link rel="stylesheet" type="text/css" href="http://blog.xivo.io/theme/css/pygments.min.css">
  <link rel="stylesheet" type="text/css" href="http://blog.xivo.io/theme/css/font-awesome.min.css">
  <link href="http://blog.xivo.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="XiVO Blog Atom">
  <link rel="shortcut icon" href="/public/favicon.ico" type="image/x-icon">
  <link rel="icon" href="/public/favicon.ico" type="image/x-icon">

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="" />
  <meta name="author" content="XiVO developers" />
  <meta name="description" content="" />
<meta property="og:site_name" content="XiVO Blog"/>
<meta property="og:type" content="blog"/>
<meta property="og:title" content="XiVO Blog"/>
<meta property="og:description" content=""/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content="http://blog.xivo.io"/>
<meta property="og:image" content="public/xivo-logo.png">
  <title>XiVO Blog</title>
</head>
<body>
  <aside>
    <div>
      <a href="http://blog.xivo.io">
        <img src="public/xivo-logo.png" alt="" title="">
      </a>
      <h1><a href="http://blog.xivo.io"></a></h1>
      <p></p>
      <nav>
        <ul class="list">
          <li><a href="http://xivo.io" target="_blank">XiVO.io</a></li>
          <li><a href="http://documentation.xivo.io" target="_blank">Documentation</a></li>
        </ul>
      </nav>
      <ul class="social">
        <li><a class="sc-twitter" href="http://twitter.com/xivodevteam" target="_blank"><i class="fa fa-twitter"></i></a></li>
        <li><a class="sc-github" href="http://github.com/xivo-pbx" target="_blank"><i class="fa fa-github"></i></a></li>
        <li><a class="sc-facebook" href="https://www.facebook.com/XiVO-86529730831" target="_blank"><i class="fa fa-facebook"></i></a></li>
      </ul>
    </div>
  </aside>
  <main>
    <nav>
      <a href="http://blog.xivo.io">Home</a>
      <a href="/categories.html">Categories</a>
      <a href="/archives.html">Archives</a>
      <a href="http://blog.xivo.io/feeds/all.atom.xml">Atom</a>
    </nav>

<article>
  <header>
    <h2><a href="http://blog.xivo.io/pcb-prototypes-and-flash-spi-testing.html#pcb-prototypes-and-flash-spi-testing">PCB prototypes and flash SPI testing</a></h2>
    <p>
      Posted on Tue 04 October 2011 in <a href="http://blog.xivo.io/category/hardware.html">Hardware</a>
    </p>
  </header>
  <div>
      <p>On the XiVO Open Hardware side, we have been very busy lately writing
various bits of low level software, preparing the production of the
first prototypes, validating some hardware subsystems and doing all sort
of hardware + low level software debugging.</p>
<p>We are starting again to have things interesting to show, with some cute
photos.</p>
<p><strong>PCB prototypes</strong></p>
<p>We recently received our first PCB prototypes for our motherboard:</p>
<p><img alt="XIOH motherboard
prototype" src="/public/.xioh_motherboard_proto_m.jpg" title="XIOH motherboard prototype, oct. 2011" /></p>
<p>To prepare for testing the first assembled prototypes, we wanted to
somehow test the communication between the EP80579 and the SPI flash.
For now we have a 74LVC125A buffer between the two chips in order to
isolate the flash from the SoC, and we wanted to validate this design.</p>
<p>We previously did a small model of the flash subsystem, A few days ago I
heavily hacked it to make it work. (Well some of the modifications were
probably not really necessary, but now we have a perfect signal quality
:)</p>
<p><img alt="Heavily hacked flash prototype
board" src="/public/.heavily_hacked_flash_proto_m.jpg" title="Heavily hacked flash prototype board, oct. 2011" /></p>
<p>The next step was to do the same test, this time using one of our spare
naked PCBs dedicated to that kind of testing.We first soldered the flash
and the buffer, then we strapped a HE10 ISP header to replace the
EP80579 SPI drivers by a flash programmer (this is obviously not a
perfect replacement, but we can't do much better...)</p>
<p>Here is a photo of the header being soldered:</p>
<p><img alt="Soldering an SPI header at SoC
position" src="/public/.soldering_an_SPI_header_at_SoC_position_m.jpg" title="Soldering an SPI header at SoC position, oct. 2011" /></p>
<p>Here is the soldered result, connected to the programmer:</p>
<p><img alt="Testing flash
communication" src="/public/.testing_flash_communication_m.jpg" title="Testing flash communication, oct. 2011" /></p>
<p>And here is the result:</p>
<p><img alt="SPI flash communication test
results" src="/public/.flash_comm_test_result_m.jpg" title="SPI flash communication test results, oct. 2011" /></p>
<p>So we are now hopeful that at least the SPI flash communication will
work on our assembled board \\o/</p>
</p>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="http://blog.xivo.io/xivo-client-architecture.html#xivo-client-architecture">XiVO Client architecture</a></h2>
    <p>
      Posted on Fri 30 September 2011 in <a href="http://blog.xivo.io/category/software.html">Software</a>
    </p>
  </header>
  <div>
      <p>This blog post extends the diagram presented earlier explaining the
<a href="/index.php?post/2011/05/13/CTI-external-architecture-in-XiVO-1.1-and-1.2" title="CTI global architecture diagram">global architecture of
CTI</a>
in XiVO.</p>
<p>Here is what the XiVO Client looks like from a developer point of
view:<img alt="XiVO Client
architecture" src="/public/.xivoclient_m.jpg" title="XiVO Client architecture, sept. 2011" /></p>
<p>This is the new architecture that will be included in our new
development iteration beginning on Monday, 3rd October.The main change
is the "creation" of the XLetlib, that was previously into the Baselib.
The Baselib will be progressively stripped of everything not necessary:
the goal is to make it a reusable component, which will only manage the
connection with the CTI server.</p>
<p>Everything in the XiVO Client is written in C++ and Qt.</p>
<p>Let's explicit the spaghetti plate above a little :XLets, for XiVO
applets, are plugins to the XiVO Client. Almost every function of the
XiVO Client is pluggable/unpluggable, depending on the server
configuration to allow some XLet to be activated. You can see what XLets
look like in the <a href="https://wiki.xivo.fr/index.php/XiVO_1.0-Dalek/Documentation_XiVO_Client" title="XiVO Client user manual">XiVO
wiki</a>
(each tab is an XLet).</p>
<p>Each XLet can use the tools available in the XLetlib, that are mainly
GUI elements used to display information in a consistent way within all
XLets. They are also given access to the Baselib "API" (it is an API,
but scarcely documented for the time being), that receives or sends CTI
events and informations to the CTI server, such as "a new phone has
registered to Asterisk", "you have a new telephone message", "I want to
call this number", etc.</p>
<p>Of course, there are some options available to control how the XiVO
Client behaves ; about half of them control GUI aspects and the other
half control how the connection is established to the server. The GUI
related options are some of the things we still have to migrate out of
the Baselib, because someone wanting to connect to the CTI server
through our Baselib does not care that the XiVO Client presence
indicator is 5 pixels wide...</p>
<p>About the communication protocol between the XiVO Client and the CTI
server, everything is JSON encoded. For now, there is no compatibility
between protocol versions, but we're thinking about it. The goal is to
be able to release XiVO Client upgrades without having to wait for the
XiVO distribution to be released, especially if the new version
introduces mainly GUI improvements. But this can't happen if an "old"
server can not talk with a more recent client.</p>
<p>One could think that working on the XiVO Client may be boring, as it's
only easy GUI stuff, placing a button here, making it violet with green
dots for obscure marketing reasons. There's a part of GUI stuff, of
course, but I find the plugins-only, freely movable (in dock mode)
interface concept very interesting, it makes the XiVO Client a potential
swiss-army knife, to which anyone can choose exactly the tools he needs,
no more, no less.</p>
<p>Some links :<br />
<a href="http://git.proformatique.com/?p=official/xivo-client-qt.git;a=summary" title="XiVO Client git repository">The XiVO Client git
repository</a><br />
<a href="https://wiki.xivo.fr/index.php/XiVO_1.2-Skaro/CTI_XiVO_Client_Qt_Developer" title="XiVO Client developer documentation">Developer oriented
documentation</a><br />
<a href="https://wiki.xivo.fr/index.php/Support_Community#IRC" title="IRC channel infos">IRC
channel</a></p>
</p>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="http://blog.xivo.io/safeguard-against-downgrades-in-xivo-packages.html#safeguard-against-downgrades-in-xivo-packages">Safeguard against downgrades in XIVO packages</a></h2>
    <p>
      Posted on Mon 26 September 2011 in <a href="http://blog.xivo.io/category/xivo-ipbx.html">XiVO IPBX</a>
      &#8226; Tagged with
      <a href="http://blog.xivo.io/tag/packages.html">packages</a>    </p>
  </header>
  <div>
      <h4>Safeguard against downgrades in XIVO packages</h4>
<p>The following use case creates a <a href="http://packaging-farm.dachary.org/trac/ticket/23">confusing
situation</a>:</p>
<ul>
<li>package-1.1-1 is submitted to the farm and successfully built</li>
<li>package-1.0-1 is submitted to the farm : it is a version lower than
    the one already built</li>
<li>packaging-farm creates package-1.1-1+build1 instead of package-1.0-1</li>
<li>the .orig.tar.gz is package-1.0.orig.tar.gz and a package-1.1.tar.gz
    is created</li>
</ul>
<p>Although building an older version of a package is not desirable, it
should not claim to succeed while creating a package inconsistent with
the orig.tar.gz file.</p>
<p>The source of the problem comes from the logic that adds a +buildX to
the debian version of a package when a package is rebuilt (for instance
because a package it depends on has been rebuilt). When this logic was
implemented, the possibility that a package with a lower version number
than a previously built package could be submitted was overlooked. It is
not the normal behavior and should be treated as an error. Instead, it
was ignored and lead to confusing results as described in the bug
report.</p>
<p>The general rule is that the packaging-farm should refuse to build a
package with a version lower than a previously build package. The goal
is to prevent downgrades because the installation scripts are not
designed for downgrades. However, this general rule cannot be applied
just by comparing the versions of the existing package ( as found in
/var/lib/packaging-farm ) and the current package ( as found in
/var/cache/packaging-farm/source ). When a package is rebuilt, the
+buildX suffix will always make the existing package more recent than
the current package. The check must therefore proceed in two steps:
first check if the existing package is more recent and then throw an
error if the reason why it is more recent is not just because there is a
+buildX appended to it.</p>
<p>The <a href="http://packaging-farm.dachary.org/trac/changeset/c1e5dff59898ab5ac0f23854f55d752f1c001a05">associated
patch</a>
also moves the extraction of the existing package version from the
makefile to the debuild.sh script. That avoids duplicating the logic. It
also gives the debuild.sh script the name of the original dsc file in
order to print a meaningfull error message.</p>
</p>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="http://blog.xivo.io/software-freedom-day-montreal.html#software-freedom-day-montreal">Software Freedom Day Montreal</a></h2>
    <p>
      Posted on Tue 20 September 2011 in <a href="http://blog.xivo.io/category/general.html">General</a>
    </p>
  </header>
  <div>
      <p>We were kindly invited to participate to the <a href="http://wiki.softwarefreedomday.org/2011/Canada/Montreal/SFD-ETS">Software Freedom
Day</a> at
Montreal. It was a great day and we had the opportunity to speak about
<a href="http://wiki.xivo.fr/">XiVo</a>.</p>
<p>Jean-Yves Lebleu talked about the software part, Nicolas Bouliane about
the hardware, and Nicolas Hicher the packaging. It was also an
opportunity to introduce the team.Thank you to Michaël Faille and Fabian
Rodriguez for the organization.</p>
<p><img alt="SFD 2011" src="/public/.IMG_20110917_142412_m.jpg" title="SFD 2011, sept. 2011" /></p>
<p>Last presentation was done at the pub :)</p>
</p>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="http://blog.xivo.io/resolving-xivo-submissions-confusion.html#resolving-xivo-submissions-confusion">resolving XiVO submissions confusion</a></h2>
    <p>
      Posted on Mon 19 September 2011 in <a href="http://blog.xivo.io/category/xivo-ipbx.html">XiVO IPBX</a>
      &#8226; Tagged with
      <a href="http://blog.xivo.io/tag/packages.html">packages</a>    </p>
  </header>
  <div>
      <h4>nothing needs to be done</h4>
<p>The rules that decide when packaging-farm should work on a package are
explained in the manual pages. However, they have changed a lot while
packaging-farm matured in the past months and they deserve a short
summary.The first step is to submit work to the packaging-farm and this
is done by the submit-xivo.sh script as follows:</p>
<div class="highlight"><pre>packaging-farm DIRECTORY=asterisk submit
</pre></div>


<p>which is run as a side effect of the command</p>
<div class="highlight"><pre>rebuild
</pre></div>


<p>which is an alias for running the <strong>rebuild</strong> target of the
<strong>/etc/packaging-farm/gallifrey.mk</strong> Makefile.What it really does is to
use the content of the XiVO git repository to create a Debian GNU/Linux
source package. It uses the debian packaging instructions found in the
git repository and follow them : it does not create rules automatically,
it fully relies on what has been done manually. It does, however,
creates the package version according to a complex set of rules,
explained in the VERSIONS section of the submit-xivo.sh.The asterisk
source package will not be generated each time the</p>
<div class="highlight"><pre>packaging-farm DIRECTORY=asterisk submit
</pre></div>


<p>is run for two reasons:</p>
<ul>
<li>To save time. It currently takes less than 30 seconds for
    packaging-farm to update the <strong>skaro</strong> build machine when nothing
    needs to be done. If the source packages were always rebuilt it
    would take at least 15 minutes.</li>
<li>To avoid checksum errors when reprepro mirrors the packages built
    by packaging-farm. When a <strong>.orig.tar.gz</strong> is built for a given
    version of a package, it is preserved. Even when the content of two
    <strong>.tar.gz</strong> are strictly identical, the file itself has a different
    md5sum signature because of the compression.</li>
</ul>
<p>The submit-xivo.sh script decides if a source package should be rebuilt
using a simple comparison : if the existing <strong>.dsc</strong> file has the same
path as the one that would be created, it declares there is no need to
re-create it. In other words, the decision to rebuild a source package
solely depends on the version number of the package.Note that when
submit-xivo.sh decides that nothing needs to be done, it does not rely
on the log history of the git repository. It only relies on the version
number. However, when <strong>VERSION_COMPUTE=true</strong> (which is the default)
the date and time of the last commit from the git repository is used to
create the version number. Therefore there is a relationship between the
history of the git repository and the decision to recreate the source
package because each new commit will create a new version.This
relationship no longer exists when <strong>VERSION_COMPUTE=false</strong> and
commits to the git repository will not have any consequence on the
decision to rebuild a source package.</p>
<h4>manually submitted packages</h4>
<p>Some packages are not yet in the git repositories and they are completly
outside the control of submit-xivo.sh. As a consequence they must be
submitted manually to packaging farm. The</p>
<div class="highlight"><pre>rebuild
</pre></div>


<p>command will not submit these packages because:</p>
<ul>
<li>it would create checksum errors when the same package version is
    submitted twice</li>
<li>it would uselessly slow down the command when nothing needs update</li>
</ul>
<p>The list of packages that need manual care is found in the
<strong>/etc/packaging-farm/gallifrey.mk</strong> or <strong>/etc/packaging-farm/skaro.mk</strong>
files:</p>
<div class="highlight"><pre><span class="x">cd /var/cache/packaging-farm/sources</span>
<span class="x">for package in asterisk-chan-capi libasterisk-perl libpri misdn-kernel misdn-user sangoma-wanpipe spandsp</span>
<span class="x">do ( rm -fr </span><span class="p">$</span><span class="nv">package</span><span class="x"> ; mkdir </span><span class="p">$</span><span class="nv">package</span><span class="x"> ; cd </span><span class="p">$</span><span class="nv">package</span><span class="x"> ; apt-get source </span><span class="p">$</span><span class="nv">package</span><span class="x"> </span>
<span class="x">      rm -f /var/cache/packaging-farm/depends/</span><span class="p">$</span><span class="nv">package</span><span class="x"> )</span>
<span class="x">done ; packaging-farm generate</span>
</pre></div>


<p>Note however that this is merely a reminder and running it without
evaluating the consequences may lead to checksum errors. The following
should be checked:</p>
<ul>
<li>from which source will the package be retrieved ?</li>
<li>which package version will be retrieved ?</li>
<li>is the package retrieved compatible with the other package in the
    build farm ?</li>
<li>is there already a package with the same version in the
    /var/cache/packaging-farm/source/package directory ?</li>
</ul>
<h4>checksum errors</h4>
<p>The gallifrey and skaro build machines output is a repository created
with reprepro. It is then mirrored, using reprepro, to mirror.xivo.fr.If
the build machines were lost and had to be reinstalled manually, all
packages would be rebuilt. As a consequence, trying to update the mirror
on mirror.xivo.fr would lead to checksum errors because both the sources
and binary files would have the same name and different checksum,
because of the same content has a different checksum after compression,
either in a <strong>.tar.gz</strong> or in a <strong>.deb</strong> . The only way to recover from
such a situation would be to :</p>
<ul>
<li>identify all packages that are to be rebuilt by the farm</li>
<li>dget from mirror.xivo.fr each of them in
    /var/lib/packaging-farm/package</li>
<li>rebuild the gallifrey / skaro meta package</li>
</ul>
<p>Doing so is, in a nutshell, re-importing the packages saved on
mirror.xivo.fr back to the build machine, as if it was the result
created with it. The actual restoration of such a catastrophic event is
likely to be more complicated in reality. But the general idea is simple
enough.A more common problem comes from the fact that mirror.xivo.fr is
a single reprepro repository that is used to merge unrelated
repositories. For instance gallifrey, gallifrey-dev, skaro, skaro-dev
and so on. Because reprepro has a single package pool shared between all
distributions, if package P-1.1.1-1 has been built on gallifrey and
gallifrey-dev, it will be imported twice with the same version but
different checksum and lead to a checksum error. There are two ways to
avoid this problem:</p>
<ul>
<li>manually ensure that such a case never happens (for instance by
    setting the VERSION_FLAVOR veriable of submit-xivo.sh to add a
    distinctive string unique to the distribution in the name of
    each package).</li>
<li>create a separate reprepro repository for each distribution</li>
</ul>
<h4>misleading error message</h4>
<p>When nothing needs to be done according to submit-xivo.sh, it shows</p>
<div class="highlight"><pre>package <span class="cp">${</span><span class="n">package</span><span class="cp">}</span> was not modified in git since the last package generation
</pre></div>


<p><a href="http://packaging-farm.dachary.org/trac/ticket/22">although it is unrelated to
git</a> when
VERSION_COMPUTE=false.The message explaining that no update is needed
is <a href="http://packaging-farm.dachary.org/trac/changeset/d6c8676bd54b95b76ce475d7fe7dbe0d2592aafa">moved to the need_update
function</a>
and displays the exact reason, path included, why no update is required.</p>
</p>
  </div>
</article>

  <div class="pagination">
    <a class="btn" href="http://blog.xivo.io/index24.html">
      <i class="fa fa-angle-left"></i> Older Posts
    </a>
      <a class="btn float-right" href="http://blog.xivo.io/index22.html">
        Newer Posts <i class="fa fa-angle-right"></i>
      </a>
  </div>

    <footer>
<p>
  &copy; XiVO developers 2015 - This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Create Commons Attribution-ShareAlike 4.0 International License</a>
</p>
<p>Built using <a href="http://getpelican.com" target="_blank">Pelican</a> - <a href="https://github.com/alexandrevicenzi/flex" target="_blank">Flex</a> theme by <a href="http://alexandrevicenzi.com" target="_blank">Alexandre Vicenzi</a></p><p>
  <a rel="license"
     href="http://creativecommons.org/licenses/by-sa/4.0/"
     target="_blank">
    <img alt="Creative Commons License"
         title="Creative Commons License"
         style="border-width:0"
         src="https://i.creativecommons.org/l/by-sa/4.0/80x15.png"
         width="80"
         height="15"/>
  </a>
</p>    </footer>
  </main>
<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " XiVO Blog ",
  "url" : "http://blog.xivo.io",
  "image": "public/xivo-logo.png",
  "description": ""
}
</script></body>
</html>