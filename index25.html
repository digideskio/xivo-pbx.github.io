<!DOCTYPE html>
<html lang="en">
<head>
  <link href='//fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,700,400italic' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" type="text/css" href="http://blog.xivo.io/theme/css/style.min.css">
  <link rel="stylesheet" type="text/css" href="http://blog.xivo.io/theme/css/pygments.min.css">
  <link rel="stylesheet" type="text/css" href="http://blog.xivo.io/theme/css/font-awesome.min.css">
  <link href="http://blog.xivo.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="XiVO Blog Atom">
  <link rel="shortcut icon" href="/public/favicon.ico" type="image/x-icon">
  <link rel="icon" href="/public/favicon.ico" type="image/x-icon">

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="" />
  <meta name="author" content="XiVO developers" />
  <meta name="description" content="" />
<meta property="og:site_name" content="XiVO Blog"/>
<meta property="og:type" content="blog"/>
<meta property="og:title" content="XiVO Blog"/>
<meta property="og:description" content=""/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content="http://blog.xivo.io"/>
<meta property="og:image" content="public/xivo-logo.png">
  <title>XiVO Blog</title>
</head>
<body>
  <aside>
    <div>
      <a href="http://blog.xivo.io">
        <img src="public/xivo-logo.png" alt="" title="">
      </a>
      <h1><a href="http://blog.xivo.io"></a></h1>
      <p></p>
      <nav>
        <ul class="list">
          <li><a href="http://xivo.io" target="_blank">XiVO.io</a></li>
          <li><a href="http://documentation.xivo.io" target="_blank">Documentation</a></li>
        </ul>
      </nav>
      <ul class="social">
        <li><a class="sc-twitter" href="http://twitter.com/xivodevteam" target="_blank"><i class="fa fa-twitter"></i></a></li>
        <li><a class="sc-github" href="http://github.com/xivo-pbx" target="_blank"><i class="fa fa-github"></i></a></li>
        <li><a class="sc-facebook" href="https://www.facebook.com/XiVO-86529730831" target="_blank"><i class="fa fa-facebook"></i></a></li>
      </ul>
    </div>
  </aside>
  <main>
    <nav>
      <a href="http://blog.xivo.io">Home</a>
      <a href="/categories.html">Categories</a>
      <a href="/archives.html">Archives</a>
      <a href="http://blog.xivo.io/feeds/all.atom.xml">Atom</a>
    </nav>

<article>
  <header>
    <h2><a href="http://blog.xivo.io/multiple-users-building-on-the-xivo-packaging-machine.html#multiple-users-building-on-the-xivo-packaging-machine">Multiple users building on the XiVO packaging machine</a></h2>
    <p>
      Posted on Tue 09 August 2011 in <a href="http://blog.xivo.io/category/xivo-ipbx.html">XiVO IPBX</a>
      &#8226; Tagged with
      <a href="http://blog.xivo.io/tag/packages.html">packages</a>    </p>
  </header>
  <div>
      <h4>multiuser locking</h4>
<p>The packaging-farm command does not behave well when two are run
simultaneously to build the same package. Nothing bad happens but fixing
the result involves umounting a number of aufs corrupted file systems
and it is inconvenient. To avoid this, the packaging-farm command was
<a href="http://packaging-farm.dachary.org/trac/changeset/8855a9c5fc09b088edaa055a33de1e820f30cc42">modified to set a lock based on the last
argument</a>.</p>
<div class="highlight"><pre>When packaging-farm is run, a lock is set on  its  last  argument.  For
       instance,

              packaging-farm asterisk

       will  set a lock on /var/lock/packaging-farm/asterisk and another invo-
       cation of the same command while this one is still  running  will  wait
       for the first command to finish. Unless the command completes on error,
       the second invocation will just echo that  nothing  needs  to  be  done
       because the previous command did all the work.

       If the command

              packaging-farm gallifrey

       is  run  and that the gallifrey package depends on the asterisk package
       and needs to build it, the same mechanism will be used.  For  instance,
       if  user  A runs packaging-farm gallifrey after user B started to build
       packaging-farm asterisk, the higher level command gallifrey will  pause
       until asterisk has finished building and then resume.
</pre></div>


<h4>multiple builds of the same version</h4>
<p>It was possible to build the same version of a given version of a
package multiple times. While this comes handy in some cases, it is
confusing in general. The user has to remember that a --reinstall is
required to get the latest version. The reprepro(1) tool refuses the new
package because it has a different checksum than the previous one. A
<a href="http://packaging-farm.dachary.org/trac/changeset/893a93e8a352b1cf0739d325603dc8d3eef38d13">+build prefix was
appended</a>
to avoid this confusion.</p>
<div class="highlight"><pre>REBUILDING PACKAGES AND PUBLISHING REPOSITORIES
       packaging-farm  allows  to  rebuild  the same version of a package. For
       instance, let say foo-1.2 was built and was made available,  either  as
       part  of  the package specific repository created with dpkg-scanpackage
       or as part of a meta package repository created with reprepro(1) A user
       then installs the package using

              apt-get update
              apt-get install foo

       At  this  point  in  time,  the  developer of foo finds a minor bug and
       rebuilds the package on packaging-farm  without  changing  the  version
       number.   packaging-farm  allows  the developer to do that, in the same
       way pbuilder or sbuild does. However, contrary to these tools,  packag-
       ing-farm  publishes the packages and provides a safeguard to avoid pub-
       lishing the same package version multiple times.

       If version 1.0-1 of a package is built and no previous version has been
       built,  nothing is done. If version 1.0-1 has already been built and is
       rebuilt because a package it depends on has been  upgraded,  packaging-
       farm  will add the +build1 suffix to the package version and it will be
       1.0-1+build1 In all further builds of the same version, the last number
       will be incremented as in 1.0-1+build2 If a new version of the package,
       say 1.1-1 is published, it will be compared to the last  built  version
       using dpkg --compare-version Because it is found to be greater, it will
       be used as if there was no previous build.
</pre></div>


</p>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="http://blog.xivo.io/xivo-package-submissions-rules.html#xivo-package-submissions-rules">XiVO package submissions rules</a></h2>
    <p>
      Posted on Mon 01 August 2011 in <a href="http://blog.xivo.io/category/xivo-ipbx.html">XiVO IPBX</a>
      &#8226; Tagged with
      <a href="http://blog.xivo.io/tag/packages.html">packages</a>    </p>
  </header>
  <div>
      <h4>conditional update based on version instead of time</h4>
<p>The following use case fails if <strong>submit-xivo.sh</strong> does not create a
source package if the timestamp of the last successfull build is more
recent than the latest commit of the debian or source repository.</p>
<ul>
<li>DIRECTORY=package submit-xivo.sh</li>
<li>checkout a tag set a day before</li>
<li>DIRECTORY=package submit-xivo.sh</li>
</ul>
<p>This problem was introduced with the implementation of the GIT_REVISION
variable that allows to chose which tag or branch the debian and source
should be set.Instead of checking for the build timestamp, the version
of the package that should be build is checked against an existing
.diff.gz file in the source directory. If no match is found, the source
package is created.The documentation was updated to reflect this new
behavior:</p>
<div class="highlight"><pre>When run as DIRECTORY=asterisk submit.xivo.sh will merge  the  asterisk
       sources  with  the  corresponding Debian GNU/Linux package instructions
       and build a source package.


       step 1 - update the git repositories
              the SOURCE_GIT and DEBIAN_GIT repositories  are  pulled  in  the
              VCS_DIR directory.

       step 2 - test dependencies
              if  there exists a .diff.gz file matching the current version of
              the package (see VERSION below), skip step 3 and step 4

       step 3 - merge sources and Debian GNU/Linux package
              the source  and  Debian  package  information  are  copied  from
              VCS_DIR and merged into PACKAGES_DIR

       step 4 - build source package
              without  any attempt at resolving dependencies, a source package
              is built using dpkg-buildpackage
</pre></div>


<h4>VERSION_FLAVOR</h4>
<p>At the request of Nicolas Hicher, the VERSION_FLAVOR variable was added
to implement the following:</p>
<div class="highlight"><pre>VERSIONS
       The XiVO source  packages  have  no  version  information.  The  Debian
       GNU/Linux  package  version  numbers are generated based on the date of
       the last commit in the source directory (not the debian directory), the
       version  of  the  third party source if any, the content of the VERSION
       file from the source directory, followed  by  the  value  of  the  VER-
       SION_FLAVOR   variable   and   its   short   hash.   V.V.V+X.X.X~YYYYM-
       MDD.HHMMSS.HASH will be the version number of a package built from  the
       third  party source version V.V.V for the benefit of XiVO version X.X.X
       where the last commit in the sources was made on YYYYMMDD.HHMMSS.  This
       last  commit  hash  is appended to the version number.  Example: aster-
       isk-1.4.42+1.1.15~20110312.102015.8ff428-1
</pre></div>


<p>and</p>
<div class="highlight"><pre>VERSION_FLAVOR=
              The content of this variable is appended to the value  found  in
              the  VERSION file and may be used to distinguish from a develop-
              ment version and a production version for instance.
              VERSION_FLAVOR=-dev
</pre></div>


</p>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="http://blog.xivo.io/avencall-at-gif-2011.html#avencall-at-gif-2011">AVENCALL at GIF 2011</a></h2>
    <p>
      Posted on Fri 29 July 2011 in <a href="http://blog.xivo.io/category/general.html">General</a>
    </p>
  </header>
  <div>
      <p><img alt="gif2011" src="/public/.bandeau_webgif11-gb_m.jpg" title="gif2011, juil. 2011" /></p>
<p>Avencall will present XiVO IPBX Open Hardware in <a href="http://www.grenoble-innovation-fair.com" title="GIF">GIF - Grenoble
Innovation Fair 2011</a> on
October 20&amp;21.</p>
<p>Tomorrow’s leading companies will gather in Grenoble, France, to present
more than 150 innovative technologies.</p>
<p>For its third edition Grenoble Innovation Fair is broadening its scope
to cover more new or emerging innovations in Europe, welcoming 150
start-ups and laboratories in an exhibition space dedicated to
networking with industry and technology demonstrations.</p>
<p>This international event, the only one of its kind in France, is being
staged by three Grenoble organizations which have pooled their resources
to bring together for two days new ventures with high-growth potential,
research laboratories, industrial firms and innovative SMEs.</p>
<p>The fair is expecting more than 1,500 participants, eager to extend
their innovation networks, identify opportunities for new partnerships
and discover unsuspected sources of innovation.</p>
</p>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="http://blog.xivo.io/xivo-farm-dedicated-to-development.html#xivo-farm-dedicated-to-development">XiVO farm dedicated to development</a></h2>
    <p>
      Posted on Mon 25 July 2011 in <a href="http://blog.xivo.io/category/xivo-ipbx.html">XiVO IPBX</a>
      &#8226; Tagged with
      <a href="http://blog.xivo.io/tag/packages.html">packages</a>    </p>
  </header>
  <div>
      <h4>XiVO submission with git version</h4>
<p>The
<a href="http://packaging-farm.dachary.org/trac/browser/submit/submit-xivo.sh?rev=934db22f985be6f102a327222a54c833380f3b13">submit-xivo.sh</a>
script uses whatever GIT version it finds to be the default. The
behavior was
<a href="http://packaging-farm.dachary.org/trac/changeset/866f47eb8cd8b43f6956fe0d326d9e77cc212a9b/">changed</a>
to allow an optional specification of the GIT revision, as documented in
the <strong>submit-xivo.sh(1)</strong> manual page.</p>
<div class="highlight"><pre>GIT_REVISION=master
              The gitrevision(7) from which both source and debian git will be
              checked out. If the value of this  variable  is  different  from
              what  it was the last time packaging-farm(1) was run, the depen-
              dency graph is cleared and all packages will be rebuild  regard-
              less.
</pre></div>


<p>The version <a href="http://packaging-farm.dachary.org/download/">2.0.7</a> has
been published with this modification.</p>
<h4>separated repository versus dedicated farm</h4>
<p>The pro and cons of were discussed with Nicolas Hicher on IRC.It was
decided that creating a dedicated farm virtual machine was the best
option.</p>
<h3>separated repositories</h3>
<p>A packaging-farm meta package would be created under the name
gallifrey-dev with a configuration <a href="http://gallifrey.dachary.org/packaging-farm/gallifrey/Makefile">similar to
gallifrey</a>.
The developer would use <strong>packaging-farm gallifrey-dev</strong> and the
packager would use <strong>packaging-farm gallifrey</strong></p>
<h3>pro</h3>
<ul>
<li>some packages that are not active are shared and do not need to be
    rebuilt twice</li>
<li>less hardware resources used (spare 1GB RAM and 30GB disk)</li>
<li>no need to maintain two machines / operating systems</li>
</ul>
<h3>cons</h3>
<ul>
<li>if a developer works on a package (say asterisk), the package would
    be rebuild three times if the following sequence of commands occur :
    packaging-farm gallifrey-dev ; packaging-farm gallifrey ;
    packaging-farm gallifrey-dev</li>
<li>the implementation of the package submission that allows to chose
    which GIT branch the packages are extracted from in the
    packaging-farm needs to be fine grained to avoid submitting a
    package just because the chosen branch changes</li>
<li>if the production repository is being prepared, the added delay
    involved when a developer and the release manager alternatively
    update the repository may be an annoying drawback</li>
<li>a given package is going to be build a number of times with the
    exact same version. This will create checksum errors in the
    mirroring of the repositories. It would require a modification of
    the submission script to always increment the debian version number.</li>
</ul>
<h3>dedicated farm</h3>
<p>A duplicate of the gallifrey VM is created. The release manager uses a
machine when stabilizing a XiVO version and always builds from a given
GIT version. The developers use another machine which is always built
from the master branch.</p>
<h3>pro</h3>
<ul>
<li>the implementation of the package submission that allows to chose
    which GIT branch the packages are extracted from in the
    packaging-farm can resubmit everything when the GIT version changes
    because this is a rare event. It is a simpler implementation.</li>
<li>there is no overhead because of duplicate builds and therefore no
    checksum errors when mirroring the repository</li>
</ul>
<h3>cons</h3>
<ul>
<li>more hardware resources required (1GB RAM + 30GB disk)</li>
<li>more machines to maintain : /etc/packaging-farm/packaging-farm.conf
    and /var/cache/packaging-farm/build/gallifrey/Makefile must be
    manually updated to be kept in sync</li>
<li>more machine names to remember for the release manager. The
    developers still only know one machine and need not be aware of the
    machine dedicated to the building of the release.</li>
</ul>
<h4>cloning the gallifrey VM</h4>
<ul>
<li>create a snapshot of the LVM volume containing the gallifrey VM disk</li>
</ul>
<!-- -->

<div class="highlight"><pre>lvcreate --snapshot --size 1G --name tmp /dev/all/f3e8d23f-21c0-417d-9b5e-91bb4da9b926.disk0
</pre></div>


<ul>
<li>create a LVM volume of the same size as the gallifrey VM disk</li>
</ul>
<!-- -->

<div class="highlight"><pre>lvcreate --size 30G --name dev all
</pre></div>


<ul>
<li>copy the snapshot to the new disk with low priority I/O</li>
</ul>
<!-- -->

<div class="highlight"><pre>ionice -c3 dd if=/dev/all/tmp of=/dev/all/dev bs=1024k
</pre></div>


<ul>
<li>remove the snapshot</li>
</ul>
<!-- -->

<div class="highlight"><pre>lvremove /dev/all/tmp
</pre></div>


<ul>
<li>assign an IP to the gallifrey-dev future VM</li>
</ul>
<!-- -->

<div class="highlight"><pre>root@host01:~# grep y-dev /etc/bind/db.farm
gallifrey-dev.xivo.vm   IN  A   10.10.60.6
</pre></div>


<ul>
<li>create a random MAC for the gallifrey-dev future VM</li>
</ul>
<!-- -->

<div class="highlight"><pre><span class="nt">MACADDR</span><span class="o">=</span><span class="s2">&quot;52:54:$(dd if=/dev/urandom count=1 2&gt;/dev/null | md5sum | sed &#39;s/^\(..\)\(..\)\(..\)\(..\).*$/\1:\2:\3:\4/&#39;)&quot;</span><span class="o">;</span> <span class="nt">echo</span> <span class="o">$</span><span class="nt">MACADDR</span>
</pre></div>


<ul>
<li>add a DHCP entry binding the MAC to the IP in
    <strong>/etc/dhcp/dhcpd.conf</strong></li>
</ul>
<!-- -->

<div class="highlight"><pre><span class="nt">host</span> <span class="nt">gallifrey-dev</span><span class="nc">.xivo.vm.farm</span> <span class="p">{</span>
        <span class="n">hardware</span> <span class="n">ethernet</span> <span class="m">52</span><span class="o">:</span><span class="m">54</span><span class="o">:</span><span class="m">86</span><span class="o">:</span><span class="n">b3</span><span class="o">:</span><span class="m">3</span><span class="n">f</span><span class="o">:</span><span class="m">10</span><span class="p">;</span>
        <span class="k">fixed</span><span class="o">-</span><span class="n">address</span> <span class="n">gallifrey</span><span class="o">-</span><span class="n">dev</span><span class="o">.</span><span class="n">xivo</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">farm</span><span class="p">;</span>
        <span class="n">option</span> <span class="n">subnet</span><span class="o">-</span><span class="n">mask</span> <span class="m">255</span><span class="o">.</span><span class="m">255</span><span class="o">.</span><span class="m">255</span><span class="o">.</span><span class="m">0</span><span class="p">;</span>
    <span class="p">}</span>
</pre></div>


<ul>
<li>reload bind and dhcp</li>
</ul>
<!-- -->

<div class="highlight"><pre>/etc/init.d/bind9 reload
/etc/init.d/isc-dhcp-server restart
</pre></div>


<ul>
<li>create the gallifrey-dev VM by adopting the dev LVM volume</li>
</ul>
<!-- -->

<div class="highlight"><pre>gnt-instance add -n host01.farm -B memory=4G -o debootstrap+default -t plain --disk 0:adopt=dev --no-install --net 0:mac=52:54:86:b3:3f:10 gallifrey-dev.xivo.vm.farm
</pre></div>


<ul>
<li>bind the SSH port of the new VM to 22006</li>
</ul>
<!-- -->

<div class="highlight"><pre><span class="x">in /etc/shorewall/rules</span>
<span class="x">DNAT           net             loc:</span><span class="p">$</span><span class="nv">VM_GALLIFREY_DEV_XIVO</span><span class="x">:22 tcp     22006           -       </span><span class="p">$</span><span class="nv">IP_FAILOVER</span><span class="x"></span>
<span class="x">in /etc/shorewall/params</span>
<span class="x">VM_GALLIFREY_DEV_XIVO=10.10.60.6</span>
</pre></div>


<ul>
<li>reload shorewall</li>
</ul>
<!-- -->

<div class="highlight"><pre>shorewall restart ; sleep 30 &amp;&amp; shorewall clear
</pre></div>


<ul>
<li>start the gallifrey-dev VM</li>
</ul>
<!-- -->

<div class="highlight"><pre>gnt-instance start gallifrey-dev.xivo.vm.farm
</pre></div>


<ul>
<li>balloon down the gallifrey-dev VM memory to 1G</li>
</ul>
<!-- -->

<div class="highlight"><pre>echo balloon 1024 | socat - unix:/var/run/ganeti/kvm-hypervisor/ctrl/gallifrey-dev.xivo.vm.farm.monitor
</pre></div>


<ul>
<li>add nginx reverse proxy in
    /etc/nginx/sites-available/gallifrey-dev.dachary.org</li>
</ul>
<!-- -->

<div class="highlight"><pre><span class="nt">server</span> <span class="p">{</span>
 <span class="n">listen</span> <span class="m">80</span><span class="p">;</span>
 <span class="n">server_name</span> <span class="n">gallifrey</span><span class="o">-</span><span class="n">dev</span><span class="o">.</span><span class="n">dachary</span><span class="o">.</span><span class="n">org</span><span class="p">;</span>
 <span class="n">access_log</span>  <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">gallifrey</span><span class="o">-</span><span class="n">dev</span><span class="o">.</span><span class="n">dachary</span><span class="o">.</span><span class="n">org</span><span class="o">.</span><span class="n">access</span><span class="o">.</span><span class="n">log</span><span class="p">;</span>

 <span class="n">location</span> <span class="o">/</span> <span class="err">{</span>
  <span class="n">proxy_pass</span>   <span class="n">http</span><span class="o">://</span><span class="n">gallifrey</span><span class="o">-</span><span class="n">dev</span><span class="o">.</span><span class="n">xivo</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">farm</span><span class="p">;</span>
 <span class="p">}</span>
<span class="err">}</span>
</pre></div>


<ul>
<li>reload nginx</li>
</ul>
<!-- -->

<div class="highlight"><pre>/etc/init.d/nginx reload
</pre></div>


</p>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="http://blog.xivo.io/coming-back-from-rmll2011.html#coming-back-from-rmll2011">Coming back from RMLL2011</a></h2>
    <p>
      Posted on Tue 19 July 2011 in <a href="http://blog.xivo.io/category/general.html">General</a>
    </p>
  </header>
  <div>
      <p>We had the last slot of the day after the lacie-nas.org talk (excellent
presentation and demonstration from Thomas Monjalon and Simon Guinot)
where it was discussed the idea of opening hardware products and the
relation between hardware manufacturers and embedded software
developers. It becomes clearer and clearer that the OpenSource community
is pushing the hardware manufacturers to open-up their specifications
(UART, GPIOs, JTAG) and allow firmware hackings and add-ons
developments.<br />
In our case, the hardware will be fully open and documented to allow
community contributions and we have several questions about TDM
extensions of our appliances with other interfaces (analog, wireless,
soundcards ...)</p>
</p>
  </div>
</article>

  <div class="pagination">
    <a class="btn" href="http://blog.xivo.io/index26.html">
      <i class="fa fa-angle-left"></i> Older Posts
    </a>
      <a class="btn float-right" href="http://blog.xivo.io/index24.html">
        Newer Posts <i class="fa fa-angle-right"></i>
      </a>
  </div>

    <footer>
<p>
  &copy; XiVO developers 2015 - This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Create Commons Attribution-ShareAlike 4.0 International License</a>
</p>
<p>Built using <a href="http://getpelican.com" target="_blank">Pelican</a> - <a href="https://github.com/alexandrevicenzi/flex" target="_blank">Flex</a> theme by <a href="http://alexandrevicenzi.com" target="_blank">Alexandre Vicenzi</a></p><p>
  <a rel="license"
     href="http://creativecommons.org/licenses/by-sa/4.0/"
     target="_blank">
    <img alt="Creative Commons License"
         title="Creative Commons License"
         style="border-width:0"
         src="https://i.creativecommons.org/l/by-sa/4.0/80x15.png"
         width="80"
         height="15"/>
  </a>
</p>    </footer>
  </main>
<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " XiVO Blog ",
  "url" : "http://blog.xivo.io",
  "image": "public/xivo-logo.png",
  "description": ""
}
</script></body>
</html>