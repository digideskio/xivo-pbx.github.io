<!DOCTYPE html>
<html lang="en">
<head>
  <link href='//fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,700,400italic' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" type="text/css" href="http://blog.xivo.io/theme/css/style.min.css">
  <link rel="stylesheet" type="text/css" href="http://blog.xivo.io/theme/css/pygments.min.css">
  <link rel="stylesheet" type="text/css" href="http://blog.xivo.io/theme/css/font-awesome.min.css">
  <link href="http://blog.xivo.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="XiVO Blog Atom">
  <link rel="shortcut icon" href="/public/favicon.ico" type="image/x-icon">
  <link rel="icon" href="/public/favicon.ico" type="image/x-icon">

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="" />
  <meta name="author" content="XiVO developers" />
  <meta name="description" content="" />
<meta property="og:site_name" content="XiVO Blog"/>
<meta property="og:type" content="blog"/>
<meta property="og:title" content="XiVO Blog"/>
<meta property="og:description" content=""/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content="http://blog.xivo.io"/>
<meta property="og:image" content="public/xivo-logo.png">
  <title>XiVO Blog</title>
</head>
<body>
  <aside>
    <div>
      <a href="http://blog.xivo.io">
        <img src="public/xivo-logo.png" alt="" title="">
      </a>
      <h1><a href="http://blog.xivo.io"></a></h1>
      <p></p>
      <nav>
        <ul class="list">
          <li><a href="http://xivo.io" target="_blank">XiVO.io</a></li>
          <li><a href="http://documentation.xivo.io" target="_blank">Documentation</a></li>
        </ul>
      </nav>
      <ul class="social">
        <li><a class="sc-twitter" href="http://twitter.com/xivodevteam" target="_blank"><i class="fa fa-twitter"></i></a></li>
        <li><a class="sc-github" href="http://github.com/xivo-pbx" target="_blank"><i class="fa fa-github"></i></a></li>
        <li><a class="sc-facebook" href="https://www.facebook.com/XiVO-86529730831" target="_blank"><i class="fa fa-facebook"></i></a></li>
      </ul>
    </div>
  </aside>
  <main>
    <nav>
      <a href="http://blog.xivo.io">Home</a>
      <a href="/categories.html">Categories</a>
      <a href="/archives.html">Archives</a>
      <a href="http://blog.xivo.io/feeds/all.atom.xml">Atom</a>
    </nav>

<article>
  <header>
    <h2><a href="http://blog.xivo.io/a-conference-with-uncle-bob.html#a-conference-with-uncle-bob">A conference with Uncle Bob</a></h2>
    <p>
      Posted on Mon 05 November 2012 in <a href="http://blog.xivo.io/category/articles.html">articles</a>
    </p>
  </header>
  <div>
      <p>Hello to everyone following the XiVO blog ! My name is Gregory Eric
Sanderson Turcot Temlett MacDonnell Forbes. I've been working on the
XiVO software team for 2 months now and the time has come to publish my
first official blog post. Enjoy ;)</p>
<p>At the end of last september, the XiVO team had the amazing chance of
attending a talk given by none other than Robert C. Martin himself ! Mr.
Martin, also known as "Uncle Bob", is a highly experienced software
developer with over 30 years of experience. The subject of his talk was
seemingly simple: What should we expect from a professional software
developer ? More that you would think. Uncle bob divided his talk into
about a dozen different expectations. Here is my personal interpretation
for each expectation he gave.</p>
<h2>You will not ship shit</h2>
<p>Pretty provocative for a first expectation, eh ?</p>
<p>Why is this even on the list ? If programmers are professionals, then
they should already be shipping quality code, right ? The reality is
that programmers have to deal with issues that can easily lower the
quality of their software:Tight deadlines, small budget, crappy code,
infuriating clients, overly complex architectures, etc. Bad habits are
hard to break, so when you start shipping shit, it becomes easier to do
so again and again.</p>
<p>But here's a thought: Software is being found increasingly more often in
critical systems, like pacemakers for example. What happens if a
programmer ships faulty software directly into a person's heart ? When
the software that wedevelop can tip the balance between life and death,
then as professionals, we should never need to "ship shit". At the very
least, we should always aim to never do so.</p>
<h2>You will ship all the time</h2>
<p>Stories about unkempt deadlines or missed release dates are all over the
internet. Worse yet, sometimes software is delivered on time, but
upgrades become catastrophic.</p>
<p>Let's face it, there will always be situations where a client who would
like additional feature X to be ready within 2 weeks, but in the end it
takes 2 months to develop. So what can you do to make the situation
better ? Well, by making sure you're always being ready to ship at a
moment's notice. Shipping all the time might seem impossible the first
time you consider it, but it forces you to develop certain habits that
make your software more stable. Namely,</p>
<ul>
<li><strong>Easier deployments</strong>. Your deployment strategy needs to be simple,
    fast, and automated. Once that's in place, you no longer need to
    plan your upgrades since you can re-use your automated procedure</li>
<li><strong>Client satisfaction</strong>. The client no longer needs to wait to get
    the latest version of your software</li>
<li><strong>Less time wasted</strong>. Less time spent on shipping and upgrades means
    more time to work on more important stuff</li>
</ul>
<p>How do you ship all the time ? One way is through Continuous
Integration, but it isn't the only approach. What's important is to find
a way that works well with your software and your team.</p>
<h2>Inexpensive Adaptability</h2>
<p>The concept of evolution is key here. Code that doesn't evolve is prone
to stagnation and becomes harder to adapt, leading to technical debt.
How do you make sure your code doesn't stagnate ? As Uncle Bob would
say: "you need to flex your code" You can test the adaptability of your
software by looking at how complex it would be to suddenly change a
major component of the system. For example: try changing the database,
use another protocol, redesign the UI. The less changes that are needed,
the more adaptive your code becomes. One example of potential
adaptability that you might consider is the SQL vs NoSQL debate. If you
suddenly needed to change from one to the other, how much effort and how
much code would you need to change ? The less there is, the better.</p>
<h2>Extreme Quality</h2>
<p>As professionals, we should always aim to produce the best work that we
can. Here's my personal list of what I consider to be quality work:</p>
<ul>
<li>Clean code</li>
<li>Code that is easy to modify</li>
<li>Clear and concise documentation</li>
<li>Simple architecture designs</li>
<li>Tests that cover all known use cases</li>
<li>Reasonnable and honest estimates</li>
<li>Calm Attitude</li>
</ul>
<p>Quality also means dealing with our mistakes. Some mistakes can be
simple to fix, others might be impossible to re-mediate. What's most
important, is that we always ask ourselves "What can I do so that I
don't repeat the same mistake next time ? "At the end of the day, we
should be proud of our job and the work we have done, knowing that we
have accomplished the best that was possible.</p>
<h2>QA will find nothing</h2>
<p>Programmers are responsible for the quality of the code they develop.
Therefore, they should also be responsible for making sure that there
are no bugs in what they give to QA. Using QA as a fallback for writing
more code without checking for bugs is a bad habit to take. Small bugs
from time to time is an acceptable limit, but if QA comes back with a
list of bugs every time, then it's probably a sign that the programmer
isn't taking the quality of his code seriously. As Uncle Bob said during
the conference, "QA should find nothing. They should even ask themselves
why they exist"</p>
<h2>We cover for each other</h2>
<p>Teamwork isn't just about cooperation with other teammates, it's also
about sharing knowledge. When you have people in a team that specialize
in a certain domain, you risk losing all the experience that he's
acquired if ever he suddenly disappears. To make sure a team can
continue going forwards, even in unexpected situations, there should
always be more that one person who has the know how for any and every
Class or module in your code. How do you go about sharing that
experience ? One way is through pair programming, but it certainly isn't
the only way. Try finding what works best with all the members of your
team.</p>
<h2>Honest estimates</h2>
<p>Programmers estimate their tasks everyday, but how many of those
estimates are "honest" ? Honest estimates means giving a straight answer
instead of changing numbers to fit time constraints or a budget. It
means giving a time range (for example: 1 to 3 weeks) instead of a time
limit that will probably be busted. It also means readjusting an
estimate the moment you realize the first one won't work anymore.
Keeping estimates honest shows that you are commited to your work. It
also gives decision makers a better picture of the complexity of the
work at hand.</p>
<h2>Automation</h2>
<p>One of the things Uncle Bob said that really struck me was "As people
whose job is to automate things, I can't believe how much time
programmers spend repeating the same mundane tasks". I have to admit, he
has a point. The time we spend writing code compared to the time we take
to test it can boggle the mind. That time that could be well spent
working on other tasks equally as important, like improving code
structure for example. Although tests can be automated through
techniques like TDD or BDD, the principle of automation can also apply
to any recurrent task that's part of your daily development tasks.</p>
<p>Let me give you an example from my team leader: At the beginning of
every sprint, he needs to generate a series of charts showing various
statistics about the project. Before, he would manually copy numbers in
a spreadsheet and generate the chart every week. Now that he's automated
the chart generation, he can spend more time with his team.</p>
<h2>Continuous aggressive learning</h2>
<p>"As programmers, we must learn to learn." Here are a few things that a
programmer needs to keep up with in order to do his job: hardware,
software, programming languages, operating systems, libraries,
frameworks. The speed at which these things can evolve is so quick that
it becomes ever more important to take the time to learn about changes
and keep up to date. Uncle Bob even suggested that the time you take to
learn these things should be separate from the time spent at work since
this represents a personal investment that enables you to stay
professional. Continuous learning is a key skill in our ever-evolving
profession. Those who fail to adapt risk falling behind.</p>
<h2>Mentoring</h2>
<p>Another approach to continuous learning is to teach. Mentoring is a way
of checking if you have a mastery of your knowledge since you need to be
proficient with your subject to teach successfully. It is also a way of
guiding other people on the path to professional software development.
Finally, mentoring can also be seen as a form of team work: there will
be more people who share the same knowledge (see "We cover for each
other" above)</p>
<h2>Conclusion</h2>
<p>I really enjoyed listening to Robert C. Martin's conference. I still
consider myself as a young programmer, and this talk has convinced me of
the importance of taking some personal time to investigate what I
personally need to change in order to, one day, proudly proclaim myself
as a "professional programmer". What I also appreciated from the talk
was Uncle Bob's focus on goals instead of techniques. In other words, no
matter what methodology or technology you prefer using (TDD, BDD, Agile,
Waterfall, C++, python, .net, java, or whatever else) we should never
lose sight of what we should be doing to stay proud about the best job
out there: programming.</p>
<p>That's it for my first blog post folks ! I hope you enjoyed it and look
forward to my next one. If you'd like to discuss more about what i've
written, you're more than welcome to leave comments.</p>
</p>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="http://blog.xivo.io/hello-xivo-add-your-web-page-to-xivo-web-interface.html#hello-xivo-add-your-web-page-to-xivo-web-interface">Hello XiVO, Add Your Web Page to XiVO Web Interface</a></h2>
    <p>
      Posted on Mon 29 October 2012 in <a href="http://blog.xivo.io/category/software.html">Software</a>
      &#8226; Tagged with
      <a href="http://blog.xivo.io/tag/development.html">development</a>,      <a href="http://blog.xivo.io/tag/i18n.html">i18n</a>,      <a href="http://blog.xivo.io/tag/web-interface.html">web-interface</a>    </p>
  </header>
  <div>
      <p>XiVO can be managed using a web interface. This interface is developed
in PHP language using a XiVO specific framework.</p>
<p>The idea of this post is to begin to demystify XiVO web interface
development.</p>
<h4>Setting The Development Environment</h4>
<p>First of all, we are going to set up of development environment. The
best is to enable nfs mount on your development workstation and to mount
the web interface development directory onto your XiVO virtual
machine.If your development projects is located in /projects/xivo-skaro,
the mount command can be :</p>
<div class="highlight"><pre><span></span>mount -t nfs devipaddress:/projects/xivo-skaro/web-interface/src /usr/share/pf-xivo-web-interface
</pre></div>


<p>Now each time you will modify a file within the web-interface directory,
you can check your update by refreshing your browser.</p>
<h4>XiVO Hello World Page</h4>
<p>So let's start by writing a simple web page to display "Hello XiVO
world", doesn't remind you something ?</p>
<h4>XiVO Actions, Applications and Objects.</h4>
<p><img alt="webi_src.png" src="/public/xivosoft/webi_src.png" title="webi_src.png, oct. 2012" />XiVO
web interface is mainly composed of three types of elements :</p>
<ul>
<li>actions, this is kind of controller, and will route the action to be
    done (list, create, edit) to the proper application</li>
<li>applications, to be considered as the business layer, contains the
    algorithm to be applied</li>
<li>objects, mainly where the persistence takes place.</li>
</ul>
<p>There are many other components, but let's start first be this simple
view.</p>
<p>So if we need to display something, we have to follow these necessary
steps :</p>
<ul>
<li>Write a simple PHP page as an action</li>
<li>Add this action in the authorized control list</li>
<li>Add it to the proper menu</li>
<li>Link the menu generated URL to the proper URL</li>
<li>Add necessary translations to XiVO translation files</li>
</ul>
<h3>Writing The Page</h3>
<p>Let's start with a simple page that we want to be displayed in the menu
"services -&gt; IPBX -&gt; Call management", edit a file
xivo-skaro/web-interface/src/action/www/service/ipbx/asterisk/call_management/hellowivo.php</p>
<div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>
    <span class="k">echo</span> <span class="s2">&quot;Hello XiVO world !&quot;</span><span class="p">;</span>
<span class="cp">?&gt;</span>
</pre></div>


<h3>XiVO Authorization Framework</h3>
<p>You cannot still browse this new page because this page is not declared
within XiVO authorization framework. The list of available pages is
located in the file
xivo-skaro/web-interface/src/object/objectconf/acl/user.inc.Edit this
file and add this new action.</p>
<div class="highlight"><pre><span></span><span class="x">....</span>
<span class="p">$</span><span class="nv">array</span><span class="x">[&#39;tree&#39;][&#39;service&#39;][&#39;ipbx&#39;][&#39;call_management&#39;][&#39;pickup&#39;] = true;</span>
<span class="p">$</span><span class="nv">array</span><span class="x">[&#39;tree&#39;][&#39;service&#39;][&#39;ipbx&#39;][&#39;call_management&#39;][&#39;schedule&#39;] = true;</span>
<span class="p">$</span><span class="nv">array</span><span class="x">[&#39;tree&#39;][&#39;service&#39;][&#39;ipbx&#39;][&#39;call_management&#39;][&#39;cel&#39;] = true;</span>
<span class="p">$</span><span class="nv">array</span><span class="x">[&#39;tree&#39;][&#39;service&#39;][&#39;ipbx&#39;][&#39;call_management&#39;][&#39;helloxivo&#39;] = true;</span>
<span class="x">.....</span>
</pre></div>


<p>Now you can browse the page https://&lt;your xivo
host&gt;/service/ipbx/index.php/call_management/helloxivo.</p>
<p>Create a XiVO user (menu Configuration-&gt; Management -&gt; Users) and
check the authorizations for this user (click on the small key icon next
to the user) and you will see that a new item appears under call
management.<img alt="webi_acl.png" src="/public/xivosoft/.webi_acl_m.jpg" title="webi_acl.png, oct. 2012" /></p>
<h3>Translation</h3>
<p>You can also note that an error message 'missing translation' is
displayed. This is a special marker to be sure that nobody forget to
write the translation strings. These translations are located in
directory src/i18n were a directory per language can be find.</p>
<p>Edit the file en_US/conf/acl.i18n and add the translation
service-ipbx-call_management-helloxivo and to not forget to add the
french translation, as in XiVO we always complete the french and english
translation.</p>
<p>Now we can display the new page, and can authorize a user to use this
new page, still to do is to be able to use this new page using XiVO
menu.</p>
<h3>XiVO Menu Entries</h3>
<p>Edit
xivo-skaro/web-interface/src/tpl/www/bloc/menu/left/service/ipbx/asterisk.php,
add the menu entry :</p>
<div class="highlight"><pre><span></span>........
        if(xivo_user::chk_acl(&#39;call_management&#39;,&#39;cel&#39;) === true):
            echo    &#39;<span class="nt">&lt;dd</span> <span class="na">id=</span><span class="s">&quot;mn-call_management--cel&quot;</span><span class="nt">&gt;</span>&#39;,
                $url-&gt;href_html($this-&gt;bbf(&#39;mn_left_callmanagement-cel&#39;),
                        &#39;service/ipbx/call_management/cel&#39;),
                &#39;<span class="nt">&lt;/dd&gt;</span>&#39;;
        endif;
        if(xivo_user::chk_acl(&#39;call_management&#39;,&#39;helloxivo&#39;) === true):
            echo    &#39;<span class="nt">&lt;dd</span> <span class="na">id=</span><span class="s">&quot;mn-call_management--helloxivo&quot;</span><span class="nt">&gt;</span>&#39;,
                $url-&gt;href_html($this-&gt;bbf(&#39;mn_left_callmanagement-helloxivo&#39;),
                        &#39;service/ipbx/call_management/helloxivo&#39;),
                &#39;<span class="nt">&lt;/dd&gt;</span>&#39;;
        endif;
        echo    &#39;<span class="nt">&lt;/dl&gt;</span>&#39;;
    endif;

........
</pre></div>


<p>Fix the translation by adding in
xivo-skaro/web-interface/src/i18n/en_US/tpl/www/bloc/menu/left/service/ipbx/asterisk.i18n
the translation to mn_left_callmanagement-helloxivo</p>
<p>The menu is now correctly displayed, but you still cannot click on it to
display your new page. We must now register the menu URL within the XiVO
framework.</p>
<h3>XiVO URL Routing</h3>
<p>Edit xivo-skaro/web-interface/src/object/objectconf/url.inc and add the
URL translation</p>
<div class="highlight"><pre><span></span><span class="x">.......</span>
<span class="p">$</span><span class="nv">array</span><span class="x">[&#39;service/ipbx/call_management/schedule&#39;] = &#39;service/ipbx/index.php/call_management/schedule/&#39;;</span>
<span class="p">$</span><span class="nv">array</span><span class="x">[&#39;service/ipbx/call_management/voicemenu&#39;] = &#39;service/ipbx/index.php/call_management/voicemenu/&#39;;</span>
<span class="p">$</span><span class="nv">array</span><span class="x">[&#39;service/ipbx/call_management/cel&#39;] = &#39;service/ipbx/index.php/call_management/cel/&#39;;</span>
<span class="p">$</span><span class="nv">array</span><span class="x">[&#39;service/ipbx/call_management/helloxivo&#39;] = &#39;service/ipbx/index.php/call_management/helloxivo/&#39;;</span>

<span class="x">.......</span>
</pre></div>


<p>Now you may click on the new menu entry and display the Hello XiVO world
page</p>
<p><img alt="webi_hello_menu.png" src="/public/xivosoft/webi_hello_menu.png" title="webi_hello_menu.png, oct. 2012" />As
you may notice this page is not displayed using XiVO look and feel, but
that's another story.</p>
</p>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="http://blog.xivo.io/visualizing-asterisk-deadlocks.html#visualizing-asterisk-deadlocks">Visualizing asterisk deadlocks</a></h2>
    <p>
      Posted on Wed 24 October 2012 in <a href="http://blog.xivo.io/category/software.html">Software</a>
    </p>
  </header>
  <div>
      <p>It has recently come to our attention that a freeze would sometimes
occur in the asterisk application shipped with XiVO.</p>
<p>When the freeze happened, no new calls would be accepted and most of the
current calls would freeze. A manual restart of the asterisk process
would then be required for the situation to get back to normal.</p>
<p>As you can understand, that's quite an unpleasant situation for a
telephony system like XiVO.</p>
<p>So we began investigating on what was causing the freeze, knowing it was
probably some deadlocks occuring in the asterisk process.Fortunately for
us, asterisk provides some compile time flags that help with debugging
such conditions. This is documented <a href="https://wiki.asterisk.org/wiki/display/AST/Getting+a+Backtrace">on the asterisk
wiki</a>.</p>
<p>After recompiling the XiVO version of asterisk with the DEBUG_THREADS
and DONT_OPTIMIZE flags, and with the help of some other people, we
were able to reproduce the freeze and get some information about the
various locks held by the various threads of the frozen asterisk process
via the "coreshow locks" command.</p>
<p>The output of the "core show locks" command looks like this:</p>
<div class="highlight"><pre><span></span><span class="gh">=======================================================================</span>
<span class="gh">=== Currently Held Locks ==============================================</span>
<span class="gh">=======================================================================</span>
===
=== &lt;pending&gt; &lt;lock#&gt; (&lt;file&gt;): &lt;lock type&gt; &lt;line num&gt; &lt;function&gt; &lt;lock name&gt; &lt;lock addr&gt; (times locked)
=== Thread ID: 0xb71ffb70 (tps_processing_function started at [  457] taskprocessor.c ast_taskprocessor_get())
=== ---&gt; Lock #0 (event.c): RDLOCK 1488 handle_event &amp;(&amp;ast_event_subs[event_types[i]])-&gt;lock 0x822aa78 (1)
    /usr/sbin/asterisk(ast_bt_get_addresses+0x19) [0x812a024]
    /usr/sbin/asterisk(__ast_rwlock_rdlock+0xae) [0x8125263]
    /usr/sbin/asterisk() [0x80ef7a5]
    /usr/sbin/asterisk() [0x8194305]
    /usr/sbin/asterisk() [0x81a5939]
    /lib/i686/cmov/libpthread.so.0(+0x5955) [0xb7324955]
    /lib/i686/cmov/libc.so.6(clone+0x5e) [0xb75361de]
=== ---&gt; Lock #1 (chan_agent.c): MUTEX 421 device_state_cb &amp;(&amp;agents)-&gt;lock 0xb64fab48 (1)
    /usr/sbin/asterisk(ast_bt_get_addresses+0x19) [0x812a024]
    /usr/sbin/asterisk(__ast_pthread_mutex_trylock+0xae) [0x8123886]
    /usr/lib/asterisk/modules/chan_agent.so(+0x2f8b) [0xb64e7f8b]
    /usr/sbin/asterisk() [0x80ef81d]
    /usr/sbin/asterisk() [0x8194305]
    /usr/sbin/asterisk() [0x81a5939]
    /lib/i686/cmov/libpthread.so.0(+0x5955) [0xb7324955]
    /lib/i686/cmov/libc.so.6(clone+0x5e) [0xb75361de]
=== ---&gt; Waiting for Lock #2 (chan_agent.c): MUTEX 430 device_state_cb &amp;p-&gt;lock 0x96a1a60 (1)
    /usr/sbin/asterisk(ast_bt_get_addresses+0x19) [0x812a024]
    /usr/sbin/asterisk(__ast_pthread_mutex_lock+0xae) [0x812351e]
    /usr/lib/asterisk/modules/chan_agent.so(+0x2fea) [0xb64e7fea]
    /usr/sbin/asterisk() [0x80ef81d]
    /usr/sbin/asterisk() [0x8194305]
    /usr/sbin/asterisk() [0x81a5939]
    /lib/i686/cmov/libpthread.so.0(+0x5955) [0xb7324955]
    /lib/i686/cmov/libc.so.6(clone+0x5e) [0xb75361de]
=== --- ---&gt; Locked Here: chan_agent.c line 516 (agent_lock_owner)
<span class="gh">=== -------------------------------------------------------------------</span>
<span class="gh">===</span>
=== Thread ID: 0xb6cffb70 (do_devstate_changes  started at [  726] devicestate.c ast_device_state_engine_init())
=== ---&gt; Lock #0 (astobj2.c): MUTEX 661 internal_ao2_callback c 0x9551498 (1)
    /usr/sbin/asterisk(ast_bt_get_addresses+0x19) [0x812a024]
    /usr/sbin/asterisk(__ast_pthread_mutex_lock+0xae) [0x812351e]
    /usr/sbin/asterisk(__ao2_lock+0x48) [0x8087fe4]
    /usr/sbin/asterisk() [0x8088b19]
    /usr/sbin/asterisk(__ao2_callback+0x56) [0x8088fa4]
    /usr/sbin/asterisk(__ao2_find+0x29) [0x80890c0]
    /usr/sbin/asterisk() [0x80afe6c]
    /usr/sbin/asterisk(ast_channel_get_by_name_prefix+0x28) [0x80aff2c]
    /usr/sbin/asterisk(ast_parse_device_state+0x43) [0x80dfc3e]
    /usr/sbin/asterisk() [0x80dff2d]
    /usr/sbin/asterisk() [0x80e03ac]
    /usr/sbin/asterisk() [0x80e0702]
    /usr/sbin/asterisk() [0x81a5939]
    /lib/i686/cmov/libpthread.so.0(+0x5955) [0xb7324955]
    /lib/i686/cmov/libc.so.6(clone+0x5e) [0xb75361de]
=== ---&gt; Waiting for Lock #1 (channel.c): MUTEX 1703 ast_channel_cmp_cb chan 0xae044858 (1)
    /usr/sbin/asterisk(ast_bt_get_addresses+0x19) [0x812a024]
    /usr/sbin/asterisk(__ast_pthread_mutex_lock+0xae) [0x812351e]
    /usr/sbin/asterisk(__ao2_lock+0x48) [0x8087fe4]
    /usr/sbin/asterisk() [0x80afa11]
    /usr/sbin/asterisk() [0x8088bdf]
    /usr/sbin/asterisk(__ao2_callback+0x56) [0x8088fa4]
    /usr/sbin/asterisk(__ao2_find+0x29) [0x80890c0]
    /usr/sbin/asterisk() [0x80afe6c]
    /usr/sbin/asterisk(ast_channel_get_by_name_prefix+0x28) [0x80aff2c]
    /usr/sbin/asterisk(ast_parse_device_state+0x43) [0x80dfc3e]
    /usr/sbin/asterisk() [0x80dff2d]
    /usr/sbin/asterisk() [0x80e03ac]
    /usr/sbin/asterisk() [0x80e0702]
    /usr/sbin/asterisk() [0x81a5939]
    /lib/i686/cmov/libpthread.so.0(+0x5955) [0xb7324955]
    /lib/i686/cmov/libc.so.6(clone+0x5e) [0xb75361de]
=== --- ---&gt; Locked Here: channel.c line 3767 (__ast_read)
=== --- ---&gt; Locked Here: chan_agent.c line 515 (agent_lock_owner)
<span class="gh">=== -------------------------------------------------------------------</span>
<span class="gh">...</span>
</pre></div>


<p>and it continues this way for a total of 363 lines.</p>
<p>The big advantage of this representation is that you have a lot of info
to help with precise diagnostics and debugging. But there is a downside
to this:it is quite hard to quickly get the "big picture" of which
thread is waiting for which other thread, etc.</p>
<p>Since it seemed like there were no tools to help us with getting the big
picture, we wrote a really simple python script that takes the output of
the "core show locks" command and outputs a directed graph in <a href="http://www.graphviz.org/content/dot-language">DOT
language</a> of the relations
between the threads. The generated graph is then fed to
<a href="http://www.graphviz.org/Home.php">graphviz</a> to generate an image like
this:</p>
<p><a href="/public/graph-locks.png" title="Asterisk Deadlock"><img alt="Asterisk
Deadlock" src="/public/.graph-locks_m.jpg" title="Asterisk Deadlock, oct. 2012" /></a></p>
<p>Each node represents a thread, labeled with its thread ID, and edges
represent a "is waiting for" relation.</p>
<p>From the above image, we clearly see that there's a deadlock between
thread 0xaeb2db70 and thread 0xb6cffb70 since both are waiting for each
other. We also see a bunch of other threads waiting directly or
indirectly on the deadlocked threads, showing the generalized freeze of
the asterisk process.</p>
<p>The script, which is named graph_ast_locks.py, can be found in <a href="https://gitorious.org/xivo/xivo-tools/trees/master/scripts">the
xivo-tools
repository</a>.
Given you have the output of a "core show locks" invocation, and that
you have graphviz installed, you can then run the following command to
generate a graph in svg format:</p>
<div class="highlight"><pre><span></span>graph_ast_locks.py core-show-locks.txt | circo -Tsvg -o graph-locks.svg
</pre></div>


</p>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="http://blog.xivo.io/test-vectors-for-smbus-packet-error-checking-pec-crc-8.html#test-vectors-for-smbus-packet-error-checking-pec-crc-8">Test vectors for SMBus Packet Error Checking (PEC) CRC-8</a></h2>
    <p>
      Posted on Tue 09 October 2012 in <a href="http://blog.xivo.io/category/hardware.html">Hardware</a>
    </p>
  </header>
  <div>
      <p>While implementing the SMBus on the MSP430 (see also the post "<a href="index.php?post/2012/09/29/An-engineering-story">An
engineering story</a>"), I
have been looking for SMBus
<a href="http://en.wikipedia.org/wiki/System_Management_Bus#Packet_Error_Checking" title="PEC"><abbrev title="Packet Error Checking">PEC</abbrev></a>
CRC-8 test vectors but could not find any.</p>
<p>A CRC is a <a href="http://en.wikipedia.org/wiki/Cyclic_redundancy_check">Cyclic Redundancy
Check</a>. It is a
little piece of data typically added at the end of a packet and used to
check with an high reliability that no unintended error occurred during
transmission (or storage). The math to do the computation and the check
of a CRC is not very complicated and can be explained to anybody who
knows how to do a <a href="http://en.wikipedia.org/wiki/Long_division">long
division</a>. The polynomial
for the SMBus PEC CRC-8 is x**8+x**2+x**1+1 -- this is a
polynomial in GF(2), but you don't really have to understand that part
to be able to use CRCs in practice. It corresponds to the binary number
100000111, to be used in a particular way. The following text explains
it better than I could:
<a href="http://www.ross.net/crc/download/crc_v3.txt" title="http://www.ross.net/crc/download/crc_v3.txt">http://www.ross.net/crc/download/cr...</a></p>
<p>I made my own SMBus PEC CRC-8 test vectors (attached to this post). The
format is one test vector per line, like:</p>
<p>TV(616263, 5F)</p>
<p>616263 is the 3-byte message in hexadecimal ("abc" in ASCII). The
resulting one byte CRC-8 in hex is 5F.</p>
<p>The test vectors are checked with an official <a href="http://smbus.org/faq/crc8Applet.htm">Java applet from
smbus.org</a>. They include at the
beginning the result for each one byte packet, which is also the table
for the fast byte based implementation: CRC = table[CRC \^ byte]
(because the initial value to use for CRC is zero), On the MSP430, this
implementation should run in something like 9 cycles per byte when
dropped in the right place. (xor CRC, Rm /* 3 cycles */; mov
table[Rm], CRC; /* 6 cycles */)</p>
</p>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="http://blog.xivo.io/an-engineering-story.html#an-engineering-story">An engineering story</a></h2>
    <p>
      Posted on Sat 29 September 2012 in <a href="http://blog.xivo.io/category/hardware.html">Hardware</a>
    </p>
  </header>
  <div>
      <p>To be able to track interesting quality metrics of our upcoming XiVO
Office product (XiVO IPBX Open Hardware project), we have decided to add
temperature sensors to our current XIOH pcb.</p>
<p>In computers, the typical way to report the temperature to the main
operating system is through SMBus. This is suitable in our case: we
already have an MSP430 microcontroller that handles the power sequence
and is connected to the SMBus of the board. We will connect some diodes
to the MSP430 to measure the temperature. So the time has come to make
use of the SMBus between the MSP and the EP80579 (our main System On
Chip), for temperature measurements and also other purposes.</p>
<p>The MSP430 does not have a full featured SMBus controller, only a
generic I2C one. SMBus is a variant of I2C, with additional electrical
and timing constraints in the physical layer and definition of the
messages at the network layer level.</p>
<p>Although formatting and parsing SMBus messages is easy, properly using
the I2C controller of the MSP430 in a multi-master environment is not
without pitfalls, even if we did not care about the SMBus timing
constraints. To do it with the needed reliability, it is necessary to
have a detailed knowledge of the whole system and to take into
consideration all kind of interactions on the bus and in the chips. In
our business, the reliability wanted by the customers is typically high
enough that it makes sense to build robust systems instead of rushing a
collapsing sandcastle to market. Plus, in that particular case, we are
dealing with the subsystem that brings and keeps the whole board
running, and for which the cost to debug in the field is absurdly high.</p>
<p>All complex chips come with various design errors, and the MSP430 is no
exception. On the exact version that we use, there are 6 documented
errors affecting the I2C controller, of which 4 clearly apply to our
board, 1 clearly does not apply, and one required careful system
analysis to determine that the preconditions to this erroneous behavior
could not happen in our system.</p>
<p>On top of the 4 errata applying to the I2C controller, we have to deal
with errata for other parts of the MSP430, plus some detailled aspects
that are not errata but are also limiting the way we can make a reliable
use of the chip for the tasks we want.Failure to properly take all those
details into consideration would lead to eventual faults of various
natures, probably including MSP430 crashes impossible to diagnose and
leading to spurious shutdowns, systems stuck in the powered state, or
any random behavior and degradation of system functions.</p>
<p>The impact could be full-scale, with potential consequences on:
availability, maintainability, safety, security, and reliability!</p>
<p>It is worthwhile to note that one of the errata that could have the
biggest consequences can only be handled by using one specific software
architecture to drive the I2C controller, and that specific software
architecture is not the first thing that comes to mind in our
preexisting firmware. This is a case where iteration on the design of
the I2C code would have meant its complete rewrite.</p>
<p>Complex systems, even moderately so, need a careful design, especially
on components that are critical for business or technical reasons.
Wishful thinking never produces high reliability and neither does
excessive reliance on luck. Modeling, even informally, sometimes pays.</p>
</p>
  </div>
</article>

  <div class="pagination">
    <a class="btn" href="http://blog.xivo.io/index16.html">
      <i class="fa fa-angle-left"></i> Older Posts
    </a>
      <a class="btn float-right" href="http://blog.xivo.io/index14.html">
        Newer Posts <i class="fa fa-angle-right"></i>
      </a>
  </div>

    <footer>
<p>
  &copy; XiVO developers 2015 - This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Create Commons Attribution-ShareAlike 4.0 International License</a>
</p>
<p>Built using <a href="http://getpelican.com" target="_blank">Pelican</a> - <a href="https://github.com/alexandrevicenzi/flex" target="_blank">Flex</a> theme by <a href="http://alexandrevicenzi.com" target="_blank">Alexandre Vicenzi</a></p><p>
  <a rel="license"
     href="http://creativecommons.org/licenses/by-sa/4.0/"
     target="_blank">
    <img alt="Creative Commons License"
         title="Creative Commons License"
         style="border-width:0"
         src="https://i.creativecommons.org/l/by-sa/4.0/80x15.png"
         width="80"
         height="15"/>
  </a>
</p>    </footer>
  </main>
<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " XiVO Blog ",
  "url" : "http://blog.xivo.io",
  "image": "public/xivo-logo.png",
  "description": ""
}
</script></body>
</html>